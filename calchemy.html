<!DOCTYPE html>
<html>

<!-- Calchemy (tm); Math Magic; http://www.calchemy.com -->
<!-- Copyright (c) 1988-2020 Ken Burgess and Rich Testardi. -->
<!-- top, right, bottom, left; max line length 180 -->

<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
<title>Calchemy&trade; -- Math Magic</title>
<style>
a { text-decoration: none; }
#results { line-height: 1.4; }
#equation { width: 96%; font-size:120%; }
#copyright { font-size:75%; padding: 0px; }
* { overflow-wrap: anywhere; word-wrap: anywhere; }
button { overflow-wrap: normal; word-wrap: normal; }
html,button,input { font: 36px Arial, Helvetica, sans-serif; padding: 15px 10px 15px 10px; margin: 15px 0px 15px 0px; }
@media(min-width:80em){ html,button,input { font: 24px Arial, Helvetica, sans-serif; padding: 10px; margin: 10px 0px 10px 0px; } }
@supports(-webkit-touch-callout:none) { button,input { -webkit-appearance: none; border-radius: 2px; } }
img { padding: 0px; margin: 10px 10px 0px 0px; }
table,tr,td { margin: 0px; padding: 0px; }
.table1,.table2 { width: 100%; }
.td3 { width: 4%; vertical-align: bottom; }
.i4 { filter: grayscale(75%) opacity(75%); }
hr { height: 2px; }
body,html { margin: 0px; }
#columns { column-width: 300px; column-count: 8; }
</style>
</head>

<body onload='Body()'>

<h1>Calchemy&trade; -- Math Magic</h1>
<p id='status'></p>
<table class='table1'><tr>
<td>
    <button type='button' onclick="Test();">Test</button>
    <button type='button' onclick="Examples();">Examples</button>
    <button type='button' onclick="Copy();">Copy All</button>
    <button type='button' onclick="Paste();">Paste</button>
    <button type='button' onclick="Load();">Load</button>
    <button type='button' onclick="Help();">Help</button>
</td>
<td style='text-align: right'>
    <button id='all' type='button' style='margin: 0px;' onclick="Delete('all')">Delete All</button>
    <button type='button' onclick="Scroll();">Bottom</button>
</td>
</tr></table>
<input type='file' id='file' style='display: none'>
<p id='results'></p>
<input id='equation' name='equation' placeholder='enter expression ? unit' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false'/>
<br>
<table class='table1'><tr>
<td>
    <button type='button' onclick="Enter();" id='enter'>Enter</button>
    <button type='button' onclick="Clear();">Clear</button>
    <button type='button' onclick="Units();">Find Units</button>
    <button type='button' onclick="Details();">Unit Details</button>
    <button type='button' onclick="Equations();">Equations</button>
</td>
<td style='text-align: right'>
    <button type='button' onclick="window.scrollTo(0, 0);">Top</button>
</td>
</tr></table>
<table class='table2' id='bottom'><tr>
<td>
<a href='http://www.calchemy.com' target='_blank'><img alt='Calchemy icon' src='data:image/jpeg;base64,
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'/></a>
</td>
<td>
<p id='copyright'>Copyright &copy; 1988-2020 Ken Burgess and Rich Testardi.
v1.17f</p>
</td>
</tr></table>

<script>
'use strict';
var custom = null;
// XXX -- for IE, replace template strings with concatenation, replace .includes with .indexOf != -1, class likely has to be removed, too

// database format:
//
//   ... # <comment>  -- optional comment (will be shown in unit definition details)
//   CATEGORY <name>  -- define category name (categories must be defined before use)
//   BASE <name>  -- define base unit name (cannot be undefined)
//   DERIVED <names> = <expression>  -- define coefficient and exponents for a derived dimension name (cannot be undefined)
//   AMBIGUOUS <names> = <expression>  -- like derived, but called out for extra testing (cannot be undefined)
//   PREFIX <names> = <expression>  -- define coefficient for a prefix name (cannot be undefined)
//   [*]<names> [+-]= <expression>  -- define or undefine a unit (* = unit is prefixable)
//
//   <names> format:
//     [<category|dimension>[, ...]:]<name>[*][, ...]  -- unit names (* = name is pluralizable)
</script>

<script>
var database =`
CATEGORY SI
CATEGORY Prefix
CATEGORY Number
CATEGORY Angle
CATEGORY Frequency
CATEGORY Angular_velocity
CATEGORY Energy
CATEGORY Torque
CATEGORY Physical_constant
CATEGORY Physical_property
CATEGORY Water
CATEGORY Ice
CATEGORY Air
CATEGORY Batteries
CATEGORY Speed_sound
CATEGORY Warn_angle
CATEGORY Warn_temperature

BASE PI #must be first
BASE RADIAN #must be second
BASE MASS
BASE LENGTH
BASE TIME
BASE TEMP
BASE STORAGE
BASE MONEY
BASE CURRENT
BASE SUBSTANCE

___PUSH Prefix,SI
PREFIX yotta,Y=1E+24
PREFIX zetta,Z=1E+21
PREFIX exa,E=1E+18
PREFIX peta,P=1E+15
PREFIX tera,T=1E+12
PREFIX giga,G=1E+09
PREFIX mega,M=1E+06
PREFIX kilo,k=1E+03
PREFIX hecto,h=1E+02
PREFIX deka,da=1E+01
PREFIX deci,d=1E-01
PREFIX centi,c=1E-02
PREFIX milli,m=1E-03
PREFIX micro,u=1E-06
PREFIX nano,n=1E-09
PREFIX pico,p=1E-12
PREFIX femto,f=1E-15
PREFIX atto,a=1E-18
PREFIX zepto,z=1E-21
PREFIX yocto,y=1E-24
___POP SI
PREFIX kibi,Ki=1024 #storage
PREFIX mebi,Mi=1024^2 #storage
PREFIX gibi,Gi=1024^3 #storage
PREFIX tebi,Ti=1024^4 #storage
PREFIX pebi,Pi=1024^5 #storage
PREFIX exbi,Ei=1024^6 #storage
PREFIX zebi,Zi=1024^7 #storage
PREFIX yobi,Yi=1024^8 #storage
___POP Prefix
___VERIFY

___PUSH Number
pi=3.14159265358979323 PI
pi_as_number,pin=3.14159265358979323
e=2.71828182845904523
___POP Number
___VERIFY

#Primary
___PUSH SI
*meter*,m,metre*=LENGTH
*gramm,gm,g,gram*=MASS
*second*,s,sec*=TIME
deltaK,deltak=TEMP #interval (T-T0) Kelvin
*ampere*,A,amp*=CURRENT
*mole*,mol=SUBSTANCE
*Angle,Warn_angle:radian*,rad=1 RADIAN
*Frequency,Warn_angle:hertz,Hz=1/second
___POP SI
*bit*,b=STORAGE
dollar*,$=MONEY
___VERIFY

#Secondary
___PUSH SI
*newton*,N=1 kilogramm meter/second^2
*Energy:joule*,J=1 newton meter
*watt*,W=1 joule/second
*pascal*,Pa,=1 newton/square meter
*coulomb*,C=ampere second
*volt*,V=1 joule/coulomb
*ohm*=1 volt/ampere
*siemens,S=1 ampere/volt
*farad*,F=1 coulomb/volt
*henry*,H=1 second^2/farad
*weber*,Wb=1 volt second
*tesla*,T=1 weber/meter^2
___POP SI
*liter*,L,litre*,l=1 cubic decimeter #was 1.000028 before 1964
*mho*=1 ampere/volt
*maxwell*,Mx=1E-08 weber #CGS
*gauss=0.0001 weber/meter^2 #CGS
*oersted,Oe=79.57747 ampere/meter
*Byte*,byte*,B,char*=8 bit #computer storage
*gamma*=1E-09 weber/meter^2
___VERIFY

#Angle or Number
___PUSH Warn_angle,Angle
cycle_as_angle,cyclea,cycle*=2 pi_as_number radian
revolution_as_angle,revolutiona,revolution*,rev_as_angle,reva,rev*=2 pi_as_number radian
___POP Angle
___PUSH Number
cycle_as_number,cyclen,cycle*=1
revolution_as_number,revolutionn,revolution*,rev_as_number,revn,rev*=1
___POP Number,Warn_angle
___VERIFY

DERIVED Mass=kilogramm
DERIVED Length=meter
DERIVED Time=second
DERIVED Temperature=deltaK
DERIVED Storage=Byte
DERIVED Network_bandwidth=megabit/second
AMBIGUOUS Storage_bandwidth=mebibyte/second
DERIVED Area=meter^2
DERIVED Volume=liter
DERIVED Speed=meter/second
DERIVED Acceleration=meter/second^2
DERIVED Force=newton
DERIVED Energy=joule
AMBIGUOUS Torque=newton meter
DERIVED Power=watt
DERIVED Pressure=pascal
DERIVED Warn_angle:Frequency=hertz
AMBIGUOUS Warn_angle:Angular_velocity=radian/second
DERIVED Warn_angle:Angular_acceleration=radian/second^2
DERIVED Density=kilogramm/liter
DERIVED Flow=liter/second
DERIVED Heat_latent_m=joule/kilogramm
AMBIGUOUS Heat_latent_v=joule/liter
DERIVED Specific_heat_m=joule/(kilogramm*deltaK)
DERIVED Specific_heat_v=joule/(liter*deltaK)
AMBIGUOUS Heat_vaporization_m=joule/kilogramm
AMBIGUOUS Heat_vaporization_v=joule/liter
AMBIGUOUS Heat_fusion_m=joule/kilogramm
AMBIGUOUS Heat_fusion_v=joule/liter
DERIVED Thermal_conductivity=watt/(meter*deltaK)
DERIVED Viscosity=pascal*second #(dynamic)
DERIVED Current=ampere
DERIVED Charge=coulomb
DERIVED Voltage=volt
DERIVED Resistance=ohm
DERIVED Capacitance=farad
DERIVED Inductance=henry
DERIVED Magnetic_flux=weber
DERIVED Magnetic_flux_density=tesla
DERIVED Substance=mole
DERIVED Energy_flux=joule/meter^2
DERIVED Molar_heat=joule/mole
DERIVED Molar_heat_capacity=joule/(mole*deltaK)
DERIVED Line_density=kilogramm/meter
DERIVED Kinematic_viscosity=meter^2/second
AMBIGUOUS Heat_combustion_m=joule/kilogramm
AMBIGUOUS Heat_combustion_v=joule/liter
DERIVED Fuel_efficiency=kilometer/liter
DERIVED Momentum=kilogramm meter/second
AMBIGUOUS Stiffness=newton/meter
DERIVED Money=dollar

___PUSH Number
percent,%=1/100
permille=1/1000
permyriad=1/10000
ppm*=1E-06 #parts per million
ppb*=1E-09 #parts per billion
ppt*=1E-12 #parts per trillion
ppq*=1E-15 #parts per quadrillion
dozen*=12
gross=144
karat*=1/24 #purity of gold (24 karat is pure)
one=1 #multiplier (1) as used in the U.S.
ten=10 #multiplier (10) as used in the U.S.
hundred=100 #multiplier (100) as used in the U.S.
thousand=1E3 #multiplier (1 000) as used in the U.S.
million=1E+06 #multiplier (1 000 000) as used in the U.S.
billion=1E+09 #multiplier (1 000 000 000) as used in the U.S.
trillion=1E+12 #multiplier (1 000 000 000 000) as used in the U.S.
quadrillion=1E+15 #multiplier (1E+15) as used in the U.S.
quintillion=1E+18 #multiplier (1E+18) as used in the U.S.
milliard=1E+09 #multiplier (1 000 000 000) as used in the U.K.
billion_long=1E+12 #multiplier (1 000 000 000 000) as used in the U.K.
trillion_long=1E+18 #multiplier (1E+18) as used in the U.K.
quadrillion_long=1E+24 #multiplier (1E+24) as used in the U.K.
quintillion_long=1E+30 #multiplier (1E+30) as used in the U.K.
___POP Number
___VERIFY

___PUSH Physical_constant,SI
dVcs=9192631770/second #transition freq of caesium 133
speed_of_light,c,light,lightspeed=2.99792458E+08 meter/second #speed of light in vacuum
plancks_const,h=6.626070E-34 joule second
electron_charge*,qe=1.602176634E-19 ampere second
boltzmann_const,k=1.380649E-23 joule/deltaK
avogadros_num,Na=6.02214076E+23/mole
___POP SI
gravity,grav=9.80665 meter/second^2 #standard acceleration of Earth's gravity
stef_boltz_const=5.67051E-08 watt/(meter^2 deltaK^4)
rydberg_const=1.09737E+07/meter
volumetric_gas_constant,V0,=22.4141 liter/mole 
molecular_gas_constant,R,r=8.31451 joule/(mole deltaK)
___POP Physical_constant
___VERIFY

___PUSH Angle
degree*,deg*=(1/180) pi_as_number radian
grade,grad=0.9 degree
arcmin*=(1/60)degree
arcsec*=(1/60)arcmin
___POP Angle
___VERIFY

#Time
minute*,min*=60 second
hour*,hr*=60 minute
day*=24 hour
year*,yr*=365 day
month*,mo*=(1/12)year
week*,wk*=7 day
decade*=10 year
century*=100 year
millennium*=1000 year
aeon*=1E+09 year
fortnight*=14 day
svedberg*=1E-13 second #Sedimentation Coefficient

#Length
*micron*=1E-06 meter
angstrom*=1E-10 meter
fermi*=1E-15 meter
*parsec*=3.0857E+16 meter
au=1.49598E+11 meter
mile_nautical,nmi=1852 meter
inch*,in=2.54 centimeter
mil*=(1/1000)inch
foot,ft,feet=12 inch
yard*,yd*=3 foot
mile*,mi=5280 foot #(U.S. statute)
link*=7.92 inch #Surveyor's
chain*=100 link #Surveyor's
pole*,perch*,rod*=5.5 yard
fathom*=6 foot
league*=3 mile
furlong*=220 yard
lightyear*,lyr*=1 speed_of_light*365.25 day
lightsecond*=1 speed_of_light*second

#Mass
poundm,lbm,lb*,pound*=453.592 gramm
ouncem,ozm,oz*,ounce*=(1/16) poundm
slug*=14593.9 gramm
grain*=(1/7000)poundm
pennyweight,dwt=24 grain #troy
hundredweight,cwt=100 poundm #avoirdupois
carat*,ct=200 milligramm #mass of gems
*amu,dalton=1.66053906660E-24 gramm #unified atomic mass unit
tonm,ton*=2000 poundm
tonm_long,ton_long=2240 poundm #imperial (U.K.)
*tonnem,tonm_metric,tonne*,ton_metric=1E+06 gramm #metric ton

#Force
poundal*,pdl=1 foot poundm/second^2
kip*=1000 poundm*gravity
dyne*=1E-05 newton
*pond*=1 gramm*gravity
*gramf,gf,g,gram*=1 gramm*gravity
poundf,lbf,lb*,pound*=1 poundm*gravity
ouncef,ozf,oz*,ounce*=1 ouncem*gravity
tonf,ton*=1 tonm*gravity
tonf_long,ton_long=2240 poundm*gravity #imperial (U.K.)
*tonnef*,tonf_metric,tonne*,ton_metric=1E+06 gramm*gravity #metric ton

#Area
are=100 square meter
decare,daa,dunam,stremma=1000 square meter
hectare*,ha=10000 square meter
sqin=1 square inch
sqft=1 square foot
sqyd=1 square yard
sqmi=1 square mile
sqcm=0.01 meter * 0.01 meter
sqmm=0.001 meter * 0.001 meter
section*=1 sqmi #land measure
acre*,ac=10 square chain #land measure

#Volume
cc*=1 cubic centimeter
cuin=1 cubic inch
cuft=1 cubic foot
cuyd=1 cubic yard
stere=1 cubic meter #volume of wood
gallon*,gal*=231 cubic inch
quart*,qt*=(1/4)gallon
pint*,pt*=(1/8) gallon
ouncefl,ozfl,floz,oz*,ounce*=(1/128)gallon
bushel*,bu=2150.42 cuin
peck*=(1/4)bushel
cord*=128 cuft #volume of wood
board_feet,bd_foot,bd_feet,bdft=144 cuin #wood
barrel_oil,bbl=42 gallon #crude oil
cup*=(1/4)quart
tablespoon*,tbsp=(1/2)ouncefl
teaspoon*,tsp*=(1/6)ouncefl

#Speed
knot*,kt,kn=1 mile_nautical/hour
ips=1 inch/second
ipm=1 inch/minute
fps=1 foot/second
fpm=1 foot/minute
mph=1 mile/hour
kph=1 kilometer/hour
mach=340 meter/second

#Acceleration
galileo*=0.01 meter/second^2

#Pressure
___PUSH Pressure
*torr=(101325/760)pascal
*bar=100000 pascal
metre_sea_water,msw=10 kilopascal
mb=millibar #pressure in millibar
atmosphere*,atm=101325 pascal #standard atmospheric pressure
psi=1 poundf/square inch
ksi=1000 poundf/square inch
mmHg,mmhg=133.3224 pascal #pressure (barometric)
inHg,inhg=mmHg * inch/millimeter
Hg,hg=mmHg/millimeter #density of mercury for pressure calculations
inWc,inwc,inH2O=248.84 pascal #inches water column at 60 degF
Wc,wc,H2O=inWc/inch #density of water for pressure calculations
barye*,barie*=0.1 pascal
baryl=1 dyne/square centimeter
pieze,pz=10000 dyne/square centimeter
___POP Pressure
___VERIFY

#Energy
___PUSH Energy
*electronvolt*,eV=1.60218E-19 joule
*calorie*,cal=4.184 joule
*watthour*,Wh,wh=3600 joule #watt hour
foodcal,cal_food,Cal,Calorie*=1 kilocalorie #food package label energy
Btu*,BTU*,btu*=1055.06 joule #international table
therm*=105.4804E+06 joule #US
quad*=1.05505585262E+18 joule
erg*=1E-07 joule #CGS
*ton_explosive,tTNT=4.184E+09 joule #ton of TNT equivalent
*BOE,boe=6.12E+09 joule #barrel of oil equivalent
*TOE,toe=41.868E+09 joule #tonne of oil equivalent
*TCE,tce=29.288E+09 joule #tonne of oil equivalent
___POP Energy
___VERIFY

#Torque
___PUSH Torque
inlb*=1 inch poundf
ftlb*=1 foot poundf
___POP Torque
___VERIFY

#Power
VA,va,var,VAR=1 watt #may be reactive power
horsepower,hp,HP=550 foot poundf/second
ton_refrig,ton_ac=200 Btu/minute #cooling equipment capacity

#Flow
cfs=1 cuft/second
cfm=1 cuft/minute
cfh=1 cuft/hour
gps=1 gallon/second
gpm=1 gallon/minute
gph=1 gallon/hour
gpd=1 gallon/day
lps=1 liter/second
lpm=1 liter/minute
lph=1 liter/hour
sverdrup*,Sv =1E6 cubic meter/second #oceanography

#Temperature
deltaR,deltar=(1/1.8)deltaK #interval (T-T0) Rankine
deltaC,deltac=1 deltaK #interval (T-T0) Celsius
deltaF,deltaf=(1/1.8)deltaK #interval (T-T0) Fahrenheit
*degK,degk=1 deltaK #absolute Kelvin
*degR,degr=1 deltaR #absolute Rankine
___PUSH Warn_temperature
*degC,degc=1 deltaC #absolute Celsius, with caution
*degF,degf=1 deltaF #absolute Fahrenheit, with caution
absC,absc=1 deltaC #absolute Celsius, with caution
absF,absf=1 deltaF #absolute Fahrenheit, with caution
___POP Warn_temperature
___VERIFY

#Angular_velocity or Frequency
___PUSH Warn_angle,Angular_velocity
rpm_as_angular_velocity,rpma*,rpm*=revolution_as_angle/minute
rps_as_angular_velocity,rpsa*,rps*=revolution_as_angle/second
cps_as_angular_velocity,cpsa*,cps*=cycle_as_angle/second
cpd_as_angular_velocity,cpda*,cpd*=cycle_as_angle/day
___POP Angular_velocity
___PUSH Frequency
rpm_as_frequency,rpmf*,rpm*=revolution_as_number/minute
rps_as_frequency,rpsf*,rps*=revolution_as_number/second
cps_as_frequency,cpsf*,cps*=cycle_as_number/second
cpd_as_frequency,cpdf*,cpd*=cycle_as_number/day
___POP Frequency,Warn_angle
___VERIFY

#Money
cent*=0.01 dollar #U.S.

mAh,mah=0.001 ampere hour
mpg=1 mile/gallon
rvalue,Rvalue,rval,Rval=1(sqft deltaF)/(Btu/hour) #thermal insulation
uvalue,Uvalue,uval,Uval=1(Btu/hour)/(sqft deltaF) #inverse of Rvalue
*bit_per_second,baud,bps=1 bit/second #DataComm
*byte_per_second,Bps=1 Byte/second #Storage

___PUSH Physical_constant
grav_const,G=6.67259E-11 newton meter^2/(kilogramm)^2 #gravitational constant
mass_electron,rm_e=9.10939E-31 kilogramm #rest mass electron
mass_proton,rm_p=1.67262E-27 kilogramm #rest mass proton
mass_neutron,rm_n=1.67493E-27 kilogramm #rest mass neutron

permeability_vac,mu0=4 pi_as_number*1E-07 henry/meter
permittivity_vac,e0=8.85419E-12 farad/meter
___POP Physical_constant
___VERIFY

___PUSH Number
bakers_dozen=13
ream*=500 #paper
proof=1/200 #alcoholic content
___POP Number
___VERIFY

shake*=1E-08 second
year_solar=3.15569E+07 second #mean solar
cron*=3.156E+13 second

mile_int=1609.34 meter
rowland*=angstrom
point*=3.5146E-04 meter #as used in printing
pica*=12 point #as used in printing
caliber=0.01 inch #gun bore diameter
bolt*=40 yard #cloth measure

dram*,drachm*=27.3438 grain #avoirdupois
ounce_troy=480 grain
pound_troy=5760 grain
cwt_long=112 poundm #imperial
stone*=14 poundm
ton_assay=29.1667 gramm #refined from ore

sthen*=1E+08 dyne

circ_inch*=(pi_as_number/4)sqin #area 1 inch diam
circ_mil*=pi_as_number*2.5E-07 sqin #area 1 mil diam
barn*=1E-28 meter^2
shed*=1E-24 barn
outhouse*=1E-06 barn

ton_ship=40 cuft #sea freight
ton_reg=100 cuft #capacity of ships
ton_disp=35 cuft #size of ships
gill*=(1/32)gallon
fluid_dram*,fldr=(1/1024)gallon
minim*=(1/60)fluid_dram
quart_dry=(1/32)bushel
pint_dry=(1/64)bushel
barrel_dry=7056 cuin #U.S. fruit, veggies etc.
gal_imp=277.42 cuin #U.K.
quart_imp=(1/4)gal_imp #U.K.
pint_imp=(1/8)gal_imp #U.K.
floz_imp=(1/160)gal_imp #U.K.
gill_imp=5 floz_imp #U.K.
bushel_imp=2219.36 cuin #U.K.
peck_imp=(1/4)bushel_imp #U.K.

benz=1 meter/second
leo*=10 meter/second^2

Energy:therm_eec=1.05506E+08 joule #European Economic Community
Energy:chu*=1.8 Btu #centigrade heat unit
Energy:thermie*=4.1868E+06 joule #U.K.
Energy:rydberg*=13.6054 electronvolt

frigorie*=50 Btu/minute #cooling equipment (Europe)

poise=0.1 pascal second #CGS
reyn*=1 (poundf/sqin)second
stokes=0.0001 meter^2/second

*Frequency:curie*,Ci,ci=3.7E+10/second #of radioactivity
*SI,Frequency:becquerel*,Bq=1/second #of radioactivity
*SI:katal,kat=mole/second

denier=1 gramm/(9000 meter) #textiles
drex=1E-04 gramm/meter #textiles
tex=1E-03 gramm/meter #textiles
poumar=1 poundm/(1E+06 yard) #textiles

langley*=41840 joule/meter^2

gib*=1 calorie/mole

clausius=1 joule/(mole deltaK)
entropy_unit=1 calorie/(mole deltaK)

rhe*=10/(pascal second) #inverse dynamic viscosity
dioptre*,diopter*=1/meter
kayser*=100/meter

year_sidereal=3.15582E+07 second
day_sidereal=8.61641E+04 second
hr_sidereal=(1/24)day_sidereal
min_sidereal=(1/60)hr_sidereal
sec_sidereal=(1/60)min_sidereal
lunour*=3543.67 second #1/30 of the time between new moons (30 lunour = 1 synodic month)
lune*=24 lunour
blink*=0.864 second

league_naut=3 mile_nautical
chain_naut=4.572 meter
cable_length=120 fathom
link_eng=12 inch #Ramden's
chain_eng=100 link_eng #Ramden's
hank*=840 yard #cloth
finger*=(7/8) inch
hand*=4 inch
pace=0.762 meter #military
span=9 inch
barleycorn*=(1/3)inch
cubit*=21.8 inch #biblical, range 17 to 22 inch

cental*=100 poundm #U.K.
quintal_imp=45.3592 kilogramm #U.K.
quintal*=100 kilogramm
dram_apoth=60 grain
ounce_apoth=480 grain
pound_apoth=5760 grain
scruple*=20 grain
brieze=1 gramm
hyl=9.80665 gramm

township*=36 section
rood*=40 pole^2 #U.K.
hide*=4.04686E+05 meter^2

hogshead*=63 gallon
butt_beer=0.490978 meter^3
butt_wine=0.954412 meter^3
bucket*=0.0181844 meter^3
bodge*=2.27305E-03 meter^3
chaldron*=1.26861 meter^3
coomb*,comb*=4 bushel
perche*=0.700841 meter^3 #masonry
puncheon*=0.327319 meter^3
raummeter*,festmeter*=1 meter^3
trug*=0.024246 meter^3
sack*=3 bushel #many other defs
amagat*=0.022414 meter^3
anker*=0.0378735 meter^3
aum*=0.136383 meter^3
jar*=0.113652 meter^3
kanne*=1E-03 meter^3
noggin*=1.42065E-04 meter^3
pipe*=0.477206 meter^3
pottle*=2.27304E-03 meter^3

Energy:cal_mean=4.19002 joule
Energy:cal_thermochem=4.184 joule
Energy:btu_mean=1055.87 joule
Energy:btu_thermochem=1054.35 joule
Energy:duty*=1.35582 joule

horsepower_metric,hp_metric,PS=75 kilogramf meter/second
horsepower_boiler,hp_boiler=9809.50 watt #bigger that hp
horsepower_electric,hp_electric=746.0 watt
horsepower_water,hp_water=746.043 watt
manpower=(1/10)horsepower

admiralty_knot*=6080 foot/hour
kine*=0.01 meter/second
celo*=0.3048 meter/second^2
pli*=17.8580 kilogramm/meter


# PHYSPROP.UNI

___PUSH Water
d_sea_water=1.025 gramm/cc
d_water=1 gramm/cc #@ 4 degC
Thermal_conductivity:tc_water=0.6 watt/(meter deltaK) #@ 20 degC
Viscosity:visc_water=0.001 pascal second #dynamic @ 20 degC
Speed_sound:ss_water=1497 meter/second #@ 20 degC
Specific_heat_m:shm_water,sh_water=1 calorie/(gramm deltaK) #mean
Specific_heat_v:shv_water,sh_water=shm_water*d_water
Heat_fusion_m:hfm_water,hf_water=144 Btu/poundm
Heat_fusion_v:hfv_water,hf_water=hfm_water*d_water
Heat_vaporization_m:hvm_water,hv_water=956 Btu/poundm
Heat_vaporization_v:hvv_water,hv_water=hvm_water*d_water
___POP Water
___VERIFY

___PUSH Ice
d_ice=0.92 gramm/cc
Specific_heat_m:shm_ice,sh_ice=0.47 Btu/(poundm deltaF)
Specific_heat_v:shv_ice,sh_ice=shm_ice*d_ice #by volume
Thermal_conductivity:tc_ice=2.18 watt/(meter deltaC)
___POP Ice
___VERIFY

___PUSH Air
d_air=0.0012928 gramm/cc #@ 1 atm, 0degC
Thermal_conductivity:tc_air=0.0242 watt/(meter deltaK) #@ 0 degC
Viscosity:visc_air=1.78E-05 pascal second #dynamic @ 20 degC
Speed_sound:ss_air=1128.86 foot/second #@ 20 degC, 50% RH
Specific_heat_m:shm_air,sh_air=0.24 calorie/(gramm deltaK) #@ 0 degC
Specific_heat_v:shv_air,sh_air=shm_air*d_air #@ 1 atm, 0 degC
___POP Air
___VERIFY

___PUSH Physical_property

d_aluminum=2.702 gramm/cc
d_copper=8.92 gramm/cc
d_gold=19.3 gramm/cc
d_iron=7.86 gramm/cc
d_lead=11.34 gramm/cc
d_silver=10.5 gramm/cc
d_brick=2.0 gramm/cc #hard
d_concrete=2.3 gramm/cc #with stone, sand
d_clay=1.8 gramm/cc #damp, plastic
d_glass=2.6 gramm/cc
d_sand=100 poundm/foot^3
d_granite=175 poundm/foot^3
d_diamond=3.3 gramm/cc
d_wood=0.55 gramm/cc #solid (pine)
d_mercury=13.5951 gramm/cc
d_gasoline=0.67 gramm/cc #liquid
d_kerosene=0.819 gramm/cc #liquid
d_propane_gas=0.00183 gramm/cc #gas
d_propane_liq=0.5 gramm/cc #liquid
d_oil=0.875 gramm/cc #liquid
d_coal=0.7 gramm/cc #bulk
d_methanol=0.810 gramm/cc #liquid
d_ethanol=0.791 gramm/cc #liquid

___PUSH Specific_heat_m
shm_aluminum,sh_aluminum=0.215 calorie/(gramm deltaC)
shm_copper,sh_copper=0.092 calorie/(gramm deltaC)
shm_gold,sh_gold=0.03 calorie/(gramm deltaC)
shm_iron,sh_iron=0.108 calorie/(gramm deltaC)
shm_lead,sh_lead=0.03 calorie/(gramm deltaC)
shm_silver,sh_silver=0.235 joule/(gramm deltaC)
shm_brick,sh_brick=0.22 Btu/(poundm deltaF)
shm_concrete,sh_concrete=0.156 Btu/(poundm deltaF)
shm_clay,sh_clay=0.92 joule/(gramm deltaC)
shm_glass,sh_glass=0.199 Btu/(poundm deltaF)
shm_sand,sh_sand=0.195 Btu/(poundm deltaF)
shm_granite,sh_granite=0.79 joule/(gramm deltaC)
shm_diamond,sh_diamond=0.63 joule/(gramm deltaC)
shm_wood,sh_wood=0.65 Btu/(poundm deltaF)
shm_mercury,sh_mercury=0.140 joule/(gramm deltaC)
shm_gasoline,sh_gasoline=0.53 Btu/(poundm deltaF)
shm_kerosene,sh_kerosene=0.48 Btu/(poundm deltaF)
___POP Specific_heat_m

___PUSH Specific_heat_v
shv_aluminum,sh_aluminum=shm_aluminum*d_aluminum
shv_copper,sh_copper=shm_copper*d_copper
shv_gold,sh_gold=shm_gold*d_gold
shv_iron,sh_iron=shm_iron*d_iron
shv_lead,sh_lead=shm_lead*d_lead
shv_silver,sh_silver=shm_silver*d_silver
shv_brick,sh_brick=shm_brick*d_brick
shv_concrete,sh_concrete=shm_concrete*d_concrete
shv_clay,sh_clay=shm_clay*d_clay
shv_glass,sh_glass=shm_glass*d_glass
shv_sand,sh_sand=shm_sand*d_sand
shv_granite,sh_granite=shm_granite*d_granite
shv_diamond,sh_diamond=shm_diamond*d_diamond
shv_wood,sh_wood=shm_wood*d_wood
shv_mercury,sh_mercury=shm_mercury*d_mercury
shv_gasoline,sh_gasoline=shm_gasoline*d_gasoline
shv_kerosene,sh_kerosene=shm_kerosene*d_kerosene
___POP Specific_heat_v

___PUSH Heat_vaporization_m
hvm_gasoline,hv_gasoline=116 Btu/poundm
hvm_kerosene,hv_kerosene=86 Btu/poundm
hvm_ethanol,hv_ethanol=367 Btu/poundm
hvm_methanol,hv_methanol=482 Btu/poundm
___POP Heat_vaporization_m

___PUSH Heat_vaporization_v
hvv_gasoline,hv_gasoline=hvm_gasoline*d_gasoline
hvv_kerosene,hv_kerosene=hvm_kerosene*d_kerosene
hvv_ethanol,hv_ethanol=hvm_ethanol*d_ethanol
hvv_methanol,hv_methanol=hvm_methanol*d_methanol
___POP Heat_vaporization_v

___PUSH Heat_fusion_m
hfm_aluminum,hf_aluminum=171 Btu/poundm
hfm_copper,hf_copper=88.2 Btu/poundm
hfm_gold,hf_gold=28.7 Btu/poundm
hfm_iron,hf_iron=117 Btu/poundm
hfm_lead,hf_lead=10 Btu/poundm
hfm_silver,hf_silver=105 joule/gramm
hfm_diamond,hf_diamond=5300 joule/gramm
hfm_mercury,hf_mercury,=5.0 Btu/poundm
___POP Heat_fusion_m

___PUSH Heat_fusion_v
hfv_aluminum,hf_aluminum=hfm_aluminum*d_aluminum
hfv_copper,hf_copper=hfm_copper*d_copper
hfv_gold,hf_gold=hfm_gold*d_gold
hfv_iron,hf_iron=hfm_iron*d_iron
hfv_lead,hf_lead=hfm_lead*d_lead
hfv_silver,hf_silver=hfm_silver*d_silver
hfv_diamond,hf_diamond=hfm_diamond*d_diamond
hfv_mercury,hf_mercury=hfm_mercury*d_mercury
___POP Heat_fusion_v

___PUSH Thermal_conductivity
tc_aluminum=238 watt/(meter deltaC)
tc_copper=397 watt/(meter deltaC)
tc_gold=318 watt/(meter deltaC)
tc_iron=79.5 watt/(meter deltaC)
tc_lead=34.7 watt/(meter deltaC)
tc_silver=428 watt/(meter deltaC)
tc_brick=0.58 watt/(meter deltaC)
tc_concrete=1 watt/(meter deltaC) #stone, sand
tc_glass=0.72 watt/(meter deltaC) #plate
tc_wood=0.11 watt/(meter deltaC) #across grain (pine)
tc_sand=0.33 watt/(meter deltaC) #dry
tc_gravel=0.38 watt/(meter deltaC) #dry
tc_diamond=554 watt/(meter deltaC)
tc_mercury=8.34 watt/(meter deltaC)
tc_glasswool=0.042 watt/(meter deltaC)
tc_styrofoam=0.036 watt/(meter deltaC)
tc_earth=1 watt/(meter deltaC) #40% water
___POP Thermal_conductivity

sun_power=3.92E+26 watt #total
solar_const=1340 watt/meter^2 #at Earths surface

___PUSH Heat_combustion_m
hcm_gasoline,hc_gasoline=20750 Btu/poundm
hcm_kerosene,hc_kerosene=19810 Btu/poundm
hcm_propane_liq,hc_propane_liq=21249 Btu/poundm
hcm_oil,hc_oil=18500 Btu/poundm #crude oil
hcm_coal,hc_coal=13000 Btu/poundm
hcm_methanol,hc_methanol=9600 Btu/poundm
hcm_ethanol,hc_ethanol=12800 Btu/poundm
hcm_wood,hc_wood=8750 Btu/poundm #most kinds (dry)
___POP Heat_combustion_m

___PUSH Heat_combustion_v
hcv_gasoline,hc_gasoline=d_gasoline*hcm_gasoline
hcv_kerosene,hc_kerosene=d_kerosene*hcm_kerosene
hcv_propane_liq,hc_propane_liq=d_propane_liq*hcm_propane_liq
hcv_propane_gas,hc_propane_gas=d_propane_gas*hcm_propane_liq
hcv_oil,hc_oil=d_oil*hcm_oil #crude oil
hcv_coal,hc_coal=d_coal*hcm_coal
hcv_methanol,hc_methanol=d_methanol*hcm_methanol
hcv_ethanol,hc_ethanol=d_ethanol*hcm_ethanol
hcv_wood,hc_wood=d_wood*hcm_wood #pine
hcv_natural_gas=1000 Btu/cubic foot
___POP Heat_combustion_v


___PUSH Batteries
# energy capacity of batteries

e_carb_aaa=2268 joule
e_carb_aa=5832 joule
e_carb_c=15120 joule
e_carb_d=38880 joule
e_carb_n=2376 joule
e_carb_9v=14580 joule

e_alk_aaa=5062 joule
e_alk_aa=11556 joule
e_alk_c=32400 joule
e_alk_d=72900 joule
e_alk_g=477900 joule
e_alk_n=4374 joule
e_alk_9v=19245 joule

e_nicd_aaa=777 joule
e_nicd_aa=2160 joule
e_nicd_subc=5184 joule
e_nicd_c=5184 joule
e_nicd_d=17280 joule
e_nicd_n=648 joule
e_nicd_9v=2419 joule

e_nimh_aaa=3456 joule
e_nimh_aa=8640 joule
e_nimh_c=21600 joule
e_nimh_d=43200 joule
e_nimh_9v=7560 joule

e_liion_14500=10656 joule
e_liion_18650=45288 joule
e_liion_21700=66600 joule
e_liion_26650=73260 joule

# voltage of batteries by chemistry
v_carb_bat=1.5 volt
v_alk_bat=1.5 volt
v_nicd_bat=1.2 volt
v_nimh_bat=1.2 volt
v_liion_bat=3.7 volt

# energy density by volume of batteries by chemistry
edv_carb_bat=549214 joule/liter
edv_alk_bat=1300000 joule/liter
edv_nicd_bat=504000 joule/liter
edv_nimh_bat=1460000 joule/liter
edv_liion_bat=2630000 joule/liter
edv_leadacid_bat=560000 joule/liter

# energy density by mass of batteries by chemistry
edm_carb_bat=130000 joule/kilogramm
edm_alk_bat=480000 joule/kilogramm
edm_nicd_bat=270000  joule/kilogramm
edm_nimh_bat=410000 joule/kilogramm
edm_liion_bat=875000 joule/kilogramm
edm_leadacid_bat=170000 joule/kilogramm

___POP Batteries

___POP Physical_property
___VERIFY


TEST 1|= 1
TEST 1|= 1
TEST 1|= 1
TEST 1|= 1
TEST e_nicd_9v? | = 2419 joule, = 2419 newton meter
`;
    // var database=...
</script>

<script>
// Calchemy (tm); Math Magic; http://www.calchemy.com
// Copyright (c) 1988-2020 Ken Burgess and Rich Testardi.

// This is the calchemy engine; it loads the database one line at a time and then runs user command lines one at a time, returning their output.

// regular expressions for string identification
// XXX -- token can use typeof for value; something for function call; anything for operator?
const value_regexp_ch =       /[0-9.]/;
const value_regexp =          /[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?/;
const value_regexp_head =    /^[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?/;
const value_regexp_tail =     /[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/;
const value_regexp_cap =  /[(]([0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?)[)][^^ ]/g;
const unit_regexp_ch =        /[_A-Za-z$%]/;
const unit_regexp =           /[_A-Za-z$%][_A-Za-z0-9$%]*/;
const unit_regexp_head =     /^[_A-Za-z$%][_A-Za-z0-9$%]*/;
const unit_regexp_tail =      /[_A-Za-z$%][_A-Za-z0-9$%]*$/;
const xunit_regexp_head =   /^[:_A-Za-z$%][_A-Za-z0-9$%:]*/;
const xunit_regexp_tail =    /[:_A-Za-z$%][_A-Za-z0-9$%:]*$/;
const unit_regexp_all =      /^[_A-Za-z$%][_A-Za-z0-9$%]*$/;
const unit_regexp_cap =   /[(]([_A-Za-z$%][_A-Za-z0-9$%]*)[)][^^ ]/g;
const operator_regexp_ch =    /[-+*/^;?()\[\]{},:=~|]/;
const opens = "([{";
const closes = ")]}";
const semicolon_alternates = "@&#!";  // prefix alternate = ~
const functions = { "square":1, "cubic":1, "sqrt":1, "sin":1, "cos":1, "tan":1, "asn":1, "acs":1, "atn":1, "ln":1, "log":1, "exp":1, "per":1 };

// this is our units database
var nextbaseunit = 0;
var freebaseunit = 0;
var units = [];  // Unit
var bases = [];  // Unit
var all_categories = [];  // string
var open_categories = [];  // string
var loading = false;  // while loading the units database, all ambiguities are turned off and primary names must be used
var deriving = false;  // while deriving units, secondary names may also be used
var defining = false;  // while defining, don't record mismatches
var evaluating = false;  // while evaluating units, free units may be used
var testing = false;  // while testing, don't prompt for equation values
var storagebase;  // may be undefined
var database_tests = "";

var invert_warn = false;  // auto-invert left-hand-side

var offset_warn = false;  // degC, absC, degF, absF
var offset_warned = false;
var cycle_warn = false;  // category Angle
var cycle_warned = false;

// these are the results from a command line
var results;  // Unit
var mismatches;  // string
var errors;  // string
var defines;  // boolean
var undefines;  // boolean

function assert(bool)
{
    if (! bool) {
        throw "assertion failed";
    }
}

// return the index of the matching parenthesis in an array of tokens
function MatchParen(tokens, i)
{
    var stack = [];
    var k = opens.indexOf(tokens[i]);
    assert(k != -1);
    stack.push(k);
    for (var j = i+1; j < tokens.length; j++) {
        k = opens.indexOf(tokens[j]);
        if (k != -1) {
            stack.push(k);
        } else if (tokens[j] == closes[stack[stack.length-1]]) {
            stack.pop();
            if (! stack.length) {
                return j;
            }
        }
    }
    throw "unmatched parenthesis " + opens[stack[stack.length-1]];
}

// add parenthesis around an interpretation if they are not already there
function Parenthesize(interpretation)
{
    if (interpretation[0] == '(' && MatchParen(interpretation, 0) == interpretation.length-1) {
        return interpretation;
    }
    return "(" + interpretation + ")";
}

// *** unit functions *****************************************************************************

class Unit {
    // return an empty or initialized unit
    constructor(names, pluralizables, coefficient, exponents, type, prefixable, categories, definition)
    {
        this.names = (names == undefined) ? [] : names.slice(0);  // array of unit names
        this.pluralizables = (pluralizables == undefined) ? [] : pluralizables.slice(0);  // array of booleans
        this.coefficient = (coefficient == undefined) ? NaN : coefficient;  // floating point
        this.exponents = (exponents == undefined) ? [] : exponents;  // array of integers
        this.type = (type == undefined) ? null : type;  // null || "BASE" || "DERIVED" || "PREFIX" || "VALUE"
        this.prefixable = (prefixable == undefined) ? false : prefixable;  // boolean
        this.categories = (categories == undefined) ? [] : categories;  // array of unit category names
        this.definition = (definition == undefined) ? "" : definition;  // string
        this.interpretation = (names == undefined) ? "" : names[0];  // string
        this.dimension = "";  // string, only for SI results
    }

    // pi analysis; check if orders of PI and RADIAN are within limits
    PiAnalysis()
    {
        // if exponents are beyond PI and RADIAN...
        if (this.exponents.length > 1) {
            if (this.exponents[0] && this.exponents[1]) {
                return false;
            }
        }
        return true;
    }

    // test if scalar zero
    Zero()
    {
        if (this.coefficient) {
            return false;
        }
        for (var i = 0; i < this.exponents.length; i++) {
            if (this.exponents[i]) {
                return false;
            }
        }
        return true;
    }

    // test if dimensions are compatible
    Compatible(unit, invert)
    {
        if (! unit) {
            return true;
        }
        // dynamically expand exponents arrays as needed
        var maxbaseunits = Math.max(this.exponents.length, unit.exponents.length);
        for (var i = this.exponents.length; i < maxbaseunits; i++) {
            this.exponents[i] = 0;
        }
        for (i = unit.exponents.length; i < maxbaseunits; i++) {
            unit.exponents[i] = 0;
        }

        // for all exponents beyond PI and RADIAN...
        for (i = 2; i < this.exponents.length; i++) {
            // if the exponent does not match...
            if (this.exponents[i] != (invert?-1:1)*unit.exponents[i]) {
                // units are incompatible
                return false;
            }
        }

        // units are compatible
        return true;
    }

    // test if units are equal (so we can undefine specifically)
    Equal(unit)
    {
        return this.Compatible(unit, false) && this.coefficient == unit.coefficient;
    }

    // test if unit is ambiguous with others (so we don't define one ambiguously unintentionally)
    Ambiguous()
    {
        for (var i = 0; i < units.length; i++) {
            if (units[i].type == "DERIVED") {
                if (this.Compatible(units[i], false)) {
                    return units[i];
                }
            }
        }
        return null;
    }

    // perform an operation on a unit and return the resulting result
    Operate(op, rhs, derivedok)
    {
        var unit = new Unit();

        // dynamically expand exponents arrays as needed
        var maxbaseunits = Math.max(this.exponents.length, rhs.exponents.length);
        for (var i = this.exponents.length; i < maxbaseunits; i++) {
            this.exponents[i] = 0;
        }
        for (i = rhs.exponents.length; i < maxbaseunits; i++) {
            rhs.exponents[i] = 0;
        }

        if (! testing && derivedok != true) {
            // XXX -- can we get rid of this code path difference for testing???
            if (this.type == "DERIVED") {
                throw "specify value for " + this.names[0];
            }
            if (op != ':' && op != '^' && rhs.type == "DERIVED") {
                throw "specify value for " + rhs.names[0];
            }
        }

        var offset = 0;
        if (this.type == "VALUE" && op == ' ') {
            if (rhs.names[0] == "absC" || rhs.names[0] == "degC") {
                offset = 273.15;
                offset_warn = true;
            } else if (rhs.names[0] == "absF" || rhs.names[0] == "degF") {
                offset = 459.67;
                offset_warn = true;
            }
        } else if (op == '?') {
            if (rhs.names[0] == "absC" || rhs.names[0] == "degC") {
                offset = 273.15;
                offset_warn = true;
            } else if (rhs.names[0] == "absF" || rhs.names[0] == "degF") {
                offset = 459.67;
                offset_warn = true;
            }
        }

        var invert = false;
        if (op == '?' && ! this.Compatible(rhs, false) && this.Compatible(rhs, true)) {
            // auto-invert left-hand-side
            invert = true;
        }

        // if we are not loading the database...
        if (! loading) {
            var display = null;
            var dividing = false;
            var multiplying = false;
            var adding = false;
            switch (op) {
                case '~':
                    display = "~";
                    multiplying = true;
                    break;
                case '>':
                    display = '+';
                    adding = true;
                    break;
                case '<':
                    display = '-';
                    adding = true;
                    break;
                case '^':
                    display = op;
                    break;
                case ' ':
                    display = op;
                    multiplying = true;
                    break;
                case '*':
                    display = ' ' + op + ' ';
                    multiplying = true;
                    break;
                case "per":
                case '/':
                    display = ' ' + op + ' ';
                    dividing = true;
                    break;
                case '+':
                case '-':
                    display = ' ' + op + ' ';
                    adding = true;
                    break;
                case ':':
                    break;
                case '@':
                    display = " * ";
                    multiplying = true;
                    break;
                case '&':
                    display = " / ";
                    dividing = true;
                    break;
            }

            // format interpretations to display with results
            if ((this.multiplying == true || rhs.multiplying == true) && (multiplying || dividing)) {
                if (this.dividing) {
                    // add the deferred parenthesis for the lhs now, if it differs from the current operation
                    this.interpretation = Parenthesize(this.interpretation);
                }
                if ((rhs.multiplying && ! multiplying) || rhs.dividing) {
                    // add the deferred parenthesis for the rhs now, if it differs from the current operation
                    rhs.interpretation = Parenthesize(rhs.interpretation);
                }
                // continue multiplication or a single division without parenthesis; we'll add them later
                assert(display != null);
                unit.interpretation = this.interpretation + display + rhs.interpretation;
            } else {
                var interpretation;
                if (op == '?') {
                    if (invert) {
                        // auto-invert left-hand-side
                        interpretation = Parenthesize(this.interpretation) + " ^ -1";
                    } else {
                        interpretation = this.interpretation;
                    }
                    // no need for deferred parenthesis at the outermost operation
                    if (offset) {
                        unit.interpretation = "(" + interpretation + " ? " + rhs.interpretation.replace(/(abs|deg)/, "delta") + ") - " + offset;
                    } else {
                        unit.interpretation = interpretation + " ? " + rhs.interpretation;
                    }
                    dividing = true;
                } else if (op == ':') {
                    // dimensional filter
                    unit.interpretation = this.interpretation;
                } else {
                    if (offset) {
                        interpretation = "(" + this.interpretation + " + " + offset + ")";
                    } else {
                        interpretation = this.interpretation;
                    }
                    if (this.multiplying || this.dividing || op == '^') {
                        // add the deferred or required parenthesis for the lhs now
                        interpretation = Parenthesize(interpretation);
                    }
                    if (rhs.multiplying || rhs.dividing) {
                        // add the deferred parenthesis for the rhs now
                        rhs.interpretation = Parenthesize(rhs.interpretation);
                    }
                    if (display != null) {
                        // normal infix operations
                        if (offset) {
                            unit.interpretation = interpretation + display + rhs.interpretation.replace(/(abs|deg)/, "delta");
                        } else {
                            unit.interpretation = interpretation + display + rhs.interpretation;
                        }
                        if (adding) {
                            // add required parenthesis now
                            unit.interpretation = Parenthesize(unit.interpretation);
                        }
                    } else if (op == '#') {
                        // solve by dimensional analysis: r/l
                        unit.interpretation = Parenthesize(interpretation) + "^-1 * " + rhs.interpretation;
                    } else if (op == '!') {
                        // solve by dimensional analysis: 1/(lr)
                        unit.interpretation = Parenthesize(interpretation + " * " + rhs.interpretation) + "^-1";
                    } else {
                        assert(0);
                    }
                }
            }

            // remove degenerate parenthesis
            var orig;
            do {
                orig = unit.interpretation;
                unit.interpretation = unit.interpretation.replace(unit_regexp_cap, "$1").replace(value_regexp_cap, "$1");
            } while (orig != unit.interpretation);

            // propagate the need for deferred parenthesis
            assert(! (multiplying && dividing));
            unit.multiplying = multiplying;
            unit.dividing = dividing;
        }

        switch (op) {
            case '^':
                // raise coefficient to dimensionless power; multiply exponents by power
                unit.coefficient = Math.pow(this.coefficient, rhs.coefficient);
                for (i = 0; i < maxbaseunits; i++) {
                    if (rhs.exponents[i]) {
                        throw "non-dimensionless exponent";
                    }
                    unit.exponents[i] = (this.exponents[i] * rhs.coefficient).toPrecision(4) * 1;  // N.B. * 1 returns to float
                    // check for non-integral exponents beyond PI and RADIAN
                    if (i > 1 && unit.exponents[i] != Math.round(unit.exponents[i])) {
                        throw "non-integral exponent";
                    }
                }
                break;

            case '~':  // prefix
            case ' ':  // implicit
            case '*':
            case '@':  // solve by dimensional analysis: l*r
                // multiply coefficients; add exponents
                // if this is an offset temperature being entered, instantly convert from offset temperature to absolute temperature
                unit.coefficient = (this.coefficient + offset) * rhs.coefficient;
                for (i = 0; i < maxbaseunits; i++) {
                    unit.exponents[i] = this.exponents[i] + rhs.exponents[i];
                }
                break;

            case "per":  // unit division
            case '/':
            case '&':  // solve by dimensional analysis: l/r
            case '?':
                // divide coefficients; subtract exponents
                // if this is an offset temperature being computed, instantly convert from absolute temperature back to offset temperature
                if (invert) {
                    unit.coefficient = (1 / this.coefficient / rhs.coefficient) - offset;
                } else {
                    unit.coefficient = (this.coefficient / rhs.coefficient) - offset;
                }
                for (i = 0; i < maxbaseunits; i++) {
                    if (invert) {
                        unit.exponents[i] = - this.exponents[i] - rhs.exponents[i];
                    } else {
                        unit.exponents[i] = this.exponents[i] - rhs.exponents[i];
                    }
                }
                break;

            case '#':  // solve by dimensional analysis: r/l
                // divide coefficients; subtract exponents
                unit.coefficient = rhs.coefficient / this.coefficient;
                for (i = 0; i < maxbaseunits; i++) {
                    unit.exponents[i] = rhs.exponents[i] - this.exponents[i];
                }
                break;

            case '!':  // solve by dimensional analysis: 1/(lr)
                // divide coefficients; subtract exponents
                unit.coefficient = 1 / (this.coefficient * rhs.coefficient);
                for (i = 0; i < maxbaseunits; i++) {
                    unit.exponents[i] = - this.exponents[i] - rhs.exponents[i];
                }
                break;

            case '>':  // unary
            case '+':
                // add coefficients for compatible exponents
                if (! this.Zero() && ! this.Compatible(rhs, false)) {
                    throw "addition of dissimilar units";
                }
                unit.coefficient = this.coefficient + rhs.coefficient;
                unit.exponents = rhs.exponents;
                if (op == '>') {
                    unit.type = rhs.type;  // preserve for unary
                }
                break;

            case '<':  // unary
            case '-':
                // subtract coefficients for compatible exponents
                if (! this.Zero() && ! this.Compatible(rhs, false)) {
                    throw "subtraction of dissimilar units";
                }
                unit.coefficient = this.coefficient - rhs.coefficient;
                unit.exponents = rhs.exponents;
                if (op == '<') {
                    unit.type = rhs.type;  // preserve for unary
                }
                break;

            case ':':
                // filter out different dimensions
                if (! this.Compatible(rhs, false)) {
                    if (this.type == "BASE") {
                        throw "specify value for " + this.names[0];  //OK
                    } else {
                        throw "incompatible units :" + rhs.interpretation;  //OK
                    }
                }
                unit.coefficient = this.coefficient;
                unit.exponents = this.exponents;
                break;

            default:
                throw "unknown operator " + op;
                //break;
        }

        return unit;
    }

    // format a unit as a dimension string
    Dimension(question)
    {
        var strings = [];

        // look for single dimension matches, possibly inverted
        var i;
        var j;
        var cont;
        var string = (question?"Dimensional Mismatch ":"") + "[";

        // for uninverted and then inverted...
        cont = false;
        for (var invert = 0; invert < 2; invert++) {
            // report ^-1 if the number of inversions is odd
            var xor = Boolean(question)!=Boolean(invert);
            // for all units...
            for (i = 0; i < units.length; i++) {
                // if this unit is a dimension...
                if (units[i].type == "DERIVED") {
                    // if this unit is a compatible dimension...
                    if (this.Compatible(units[i], xor)) {
                        // format its name
                        if (cont) {
                            // "or" if more than one
                            string += " or ";
                        }
                        string += units[i].names[0] + (invert?"^-1":"");
                        cont = true;
                     }
                }
            }
        }

        // count the number of non-0 dimensions
        j = 0;
        for (i = 2; i < nextbaseunit; i++) {
            if (this.exponents[i]) {
                j += Math.abs(this.exponents[i]);
            }
        }

        // if we don't have a matching derived dimension or there is more than one non-0 dimension...
        if (! cont || j > 1) {
            // also match individual base dimensions and powers
            if (cont) {
                // "or" if more than one
                string += " or ";
            }
            // for each base unit beyond PI and RADIAN...
            cont = false;
            for (i = 2; i < nextbaseunit; i++) {
                // if the exponent is non-0...
                var remaining = this.exponents[i]*(question?-1:1);
                if (remaining) {
                    // format its name
                    if (cont) {
                        // multiply if more than one
                        string += "*";
                    }
                    string += bases[i].names[0] + (remaining!=1?"^"+remaining:"");
                    cont = true;
                }
            }
        }

        string += "]";

        // return the individual base dimensions and powers
        strings.push("> " + Simplify(this.interpretation));
        strings.push(string);
        return strings;
    }

    // format a unit as an SI result string
    SI()
    {
        // look for a single dimension match, possibly inverted
        var i;
        var denom;
        var result;
        var results = [];

        // for uninverted and then inverted...
        for (var invert = 0; invert < 2; invert++) {
            // for all units...
            for (i = 0; i < units.length; i++) {
                // if this unit is a derived unit...
                if (units[i].type == "DERIVED") {
                    // if this unit is a compatible derived unit...
                    if (this.Compatible(units[i], invert)) {
                        // calculate the SI result in terms of the derived unit
                        denom = units[i].Operate('^', Value(invert?-1:1), true);
                        denom.interpretation = "[" + units[i].names[0] + "]" + (invert?"^-1":"");
                        result = this.Operate('?', denom, true);
                        result.dimension = (invert?"(":"") + units[i].definition.replace(/.*= */, "").replace(/ *[#].*/, "").trim() + (invert?")^-1":"");
                        if (result.PiAnalysis()) {
                            // we have a winner
                            results.push(result);
                            if (units[i].categories.includes("Warn_angle")) {
                                cycle_warn = true;
                            }
                        }
                    }
                }
            }
            // if we found a result...
            if (results.length) {
                // N.B. if we match an uninverted dimension, skip the inverted ones
                // return it
                return results;
            }
        }

        // otherwise, we have to match individual base dimensions and powers

        denom = null;
        var string =  "";
        // for each exponent beyond PI and RADIAN...
        for (i = 2; i < this.exponents.length; i++) {
            // if the exponent is non-0...
            if (this.exponents[i]) {
                // find the derived unit for the exponent
                var exponent = this.exponents[i];
                for (var ii = 0; ii < units.length; ii++) {
                    if (units[ii].type == "DERIVED" && bases[i].Compatible(units[ii], false)) {
                        // and divide the overall result by the derived unit
                        var term;
                        if (exponent == 1) {
                            term = units[ii];
                        } else {
                            term = units[ii].Operate('^', Value(this.exponents[i]), true);
                        }
                        if (! denom) {
                            denom = term;
                        } else {
                            // multiply if more than one term
                            denom = denom.Operate('*', term, true);
                            string += "*";
                        }
                        // format the derived unit name
                        string += units[ii].definition.replace(/.*= */, "") + (exponent!=1?"^"+exponent:"");
                        break;
                    }
                }
                // if we did not find a derived unit...
                if (ii == units.length) {
                    throw "missing DERIVED unit for " + bases[i].names[0];
                }
            }
        }

        // return the overall coefficient and individual base dimensions and powers
        if (! denom) {
            denom = Value(1).Operate('^', Value(1), true);
        }
        denom.interpretation = "";
        result = this.Operate('?', denom, true);
        result.dimension = string;
        results.push(result);
        return results;
    }
}

// define a new base unit in the units database
function DefineBaseUnit(names, pluralizable)
{
    // pick a new exponent
    var unit = new Unit(names, [pluralizable], 1, [], "BASE", false, [], "");
    for (var i = 0; i < nextbaseunit; i++) {
        unit.exponents[i] = 0;
    }
    // set just this exponent to 1
    unit.exponents[nextbaseunit] = 1;
    bases[nextbaseunit] = unit;
    nextbaseunit++;
    // make the unit (mostly) immutable
    Object.freeze(unit);
    units.push(unit);
    // return the unit
    return unit;
}

// return a primary unit from the units database
// N.B. caller must throw!
function LookupUnit(name)
{
    // if this is a precomputed unit to make loading faster
    if (name[0] == 'x' && name.match(/^xx[0-9]/)) {
        // no need to search, just return the unit
        return units[name.replace(/^xx/, "")];
    }
    // otherwise, for all units...
    for (var i = 0; i < units.length; i++) {
        var unit = units[i];
        // for all appropriate unit names...
        for (var j = 0; j < unit.names.length; j++) {
            // if the name matches...
            if (name == unit.names[j]) {
                // return the unit
                return unit;
            }
            if (loading && ! deriving) {
                // be quick
                break;
            }
            if (unit.type == "PREFIX") {
                break;
            }
        }
    }
    // unit not found
    return null;
}

// return a prefix and a primary unit from the units database
function LookupPrefixedUnit(name)
{
    // for all unit names...
    for (var ii = 0; ii < units.length; ii++) {
        // if this is a prefix...
        if (units[ii].type == "PREFIX") {
            var storage = units[ii].names[0].slice(2) == "bi";  // storage prefix
            // for all prefix names...
            for (var jj = 0; jj < units[ii].names.length; jj++) {
                var prefix = units[ii].names[jj];
                // if the specified name matches the prefix...
                if (name[0] == prefix[0] && name.indexOf(prefix) == 0 && name.length > prefix.length) {
                    // prefix match
                    var remain = name.slice(prefix.length);
                    // for all unit names...
                    for (var i = 0; i < units.length; i++) {
                        // if this unit is prefixable...
                        if (units[i].prefixable) {
                            if (storage && (units[i].exponents.length < storagebase || units[i].exponents[storagebase] == 0)) {
                                // not storage
                                continue;
                            }
                            // for all unit names...
                            for (var j = 0; j < units[i].names.length; j++) {
                                // if the remainder of the specified name matches the unit...
                                if (remain == units[i].names[j]) {
                                    // return the prefix and unit
                                    return [units[ii], units[i]];
                                }
                                if (loading && ! deriving) {
                                    // be quick
                                    break;
                                }
                            }
                        }
                    }
                }
                if (loading && ! deriving) {
                    // be quick
                    break;
                }
            }
        }
    }
    // prefix and unit not found
    throw "undefined unit " + name;
}

// *** expression evaluation **********************************************************************

// return a literal value as a unit
function Value(token)
{
    var unit = new Unit([token]);
    unit.coefficient = Number(token);
    if (isNaN(unit.coefficient)) {
        throw "bad value " + token;  //OK
    }
    unit.type = "VALUE";
    return unit;
}

// operator precedences
var prec = {
    '~':    3,  // left-to-right associativity  (prefix multiplication)
    '>':    2,  // right-to-left associativity  (unary +)
    '<':    2,  // right-to-left associativity  (unary -)
    '^':    1,  // right-to-left associativity
    ' ':    0,  // left-to-right associativity  (implied multiplication)
    "per": -1,  // left-to-right associativity  (unit division)
    '*':   -1,  // left-to-right associativity
    '/':   -1,  // left-to-right associativity
    '+':   -2,  // left-to-right associativity
    '-':   -2,  // left-to-right associativity
    ':':   -3,  // left-to-right associativity  (dimensional filter)
    '@':   -4,  // left-to-right associativity  (solve by dimensional analysis: l*r)
    '&':   -4,  // left-to-right associativity  (solve by dimensional analysis: l/r)
    '#':   -4,  // left-to-right associativity  (solve by dimensional analysis: r/l)
    '!':   -4,  // left-to-right associativity  (solve by dimensional analysis: 1/(lr))
    '?':   -5,  // left-to-right associativity
    "zz":  -7,
};

// operator associativities
var right = "<>^";

// clean low precedence operators off the stack and push a new operator on the stack if needed and set the next result
function CleanAndPush(stack, result, op, next)
{
    assert(prec.hasOwnProperty(op));

    // handle stacked operator precedence and associativity; clean stack as needed
    if (result != null || op == 'zz') {
        while (stack.length) {
            // get the top operation on the stack
            var stacked = stack[stack.length-1];
            // if the operator has right-to-left associativity, pop if the operator precedence is greater-than the current precedence;
            // otherwise, pop if the operator precedence is greater-than-or-equal-to the current precedence
            var pop = (right.indexOf(stacked.op) != -1) ? (stacked.prec > prec[op]) : (stacked.prec >= prec[op]);

            if (! pop) {
                // we're done popping
                break;
            }
            // pop and clean
            stacked = stack.pop();
            if (result != null) {
                // perform the stacked operation
                result = stacked.result.Operate(stacked.op, result);
            } else {
                // SI result requested thru '?' with no rhs; no operation
                assert(stacked.op == '?');
                result = stacked.result;
            }
        }
    }

    // if we are still evaluating (and not finalizing the stack)...
    if (op != "zz") {
        // if there is a previous result...
        if (result != null) {
            // push the previous result and a new operator on the stack
            stack.push({ result: result, op: op, prec: prec[op] });
        }

        // and set the current result
        result = next;
    }

    // return the current result
    return result;
}

// evaluate a single expression in an array of tokens and return a single result
function EvaluateTokens(tokens)
{
    var j;
    var subtokens;
    var stack = [];
    var token = null;
    var result = null;

    // for all tokens in the equation...
    for (var i = 0; i < tokens.length; i++) {
        token = tokens[i];
        // if the token is a function call...
        if (functions.hasOwnProperty(token)) {
            if (token == "per") {
                // unit division
                result = CleanAndPush(stack, result, token, null);
            } else {
                var unit;
                if (tokens.length > i+1 && opens.indexOf(tokens[i+1]) != -1) {
                    // power, trig, log, etc. followed by parenthetical expression
                    j = MatchParen(tokens, i+1);
                    subtokens = tokens.slice(i+2, j);
                    unit = EvaluateTokens(subtokens);
                    i = j;
                } else if (tokens.length > i+3 && tokens[i+2] == '~') {
                    // power, trig, log, etc. followed by prefixed unit
                    unit = EvaluateTokens([tokens[i+1], '~', tokens[i+3]]);
                    i = i+3;
                } else if (tokens.length > i+1) {
                    // power, trig, log, etc. followed by unit or number
                    unit = EvaluateTokens([tokens[i+1]]);
                    i = i+1;
                } else {
                    throw "missing argument " + tokens[i];
                }
                result = CleanAndPush(stack, result, ' ', unit);
                if (token == "square") {
                    result = CleanAndPush(stack, result, '^', Value("2"));
                } else if (token == "cubic") {
                    result = CleanAndPush(stack, result, '^', Value("3"));
                } else if (token == "sqrt") {
                    result = CleanAndPush(stack, result, '^', Value("0.5"));
                } else {
                    var interpretation = token + "{" + result.interpretation + "}";
                    // check that argument is dimensionless beyond PI and RADIAN...
                    for (j = 2; j < result.exponents.length; j++) {
                        if (result.exponents[j]) {
                            throw "non-dimensionless argument";  //OK
                        }
                    }
                    if (token == "sin") {
                        result = Value(Math.sin(result.coefficient));
                    } else if (token == "cos") {
                        result = Value(Math.cos(result.coefficient));
                    } else if (token == "tan") {
                        result = Value(Math.tan(result.coefficient));
                    } else if (token == "asn") {
                        // range -1..1
                        result = Value(Math.asin(result.coefficient));
                    } else if (token == "acs") {
                        // range -1..1
                        result = Value(Math.acos(result.coefficient));
                    } else if (token == "atn") {
                        result = Value(Math.atan(result.coefficient));
                    } else if (token == "ln") {
                        result = Value(Math.log(result.coefficient));
                    } else if (token == "log") {
                        result = Value(Math.log(result.coefficient)/Math.log(10));
                    } else if (token == "exp") {
                        result = Value(Math.exp(result.coefficient));
                    } else {
                        throw "bad function " + token;
                    }
                    result.interpretation = interpretation;
                }
            }

        // otherwise, if the token opens a parenthetical expression...
        } else if (opens.indexOf(token) != -1) {
            // parenthetical expression
            j = MatchParen(tokens, i);
            subtokens = tokens.slice(i+1, j);
            result = CleanAndPush(stack, result, ' ', EvaluateTokens(subtokens));
            i = j;

        // otherwise, if the token is a numeric value...
        } else if (token[0].match(value_regexp_ch)) {
            // value
            result = CleanAndPush(stack, result, ' ', Value(token));

        // otherwise, if the token is a symbolic unit value...
        } else if (token[0].match(unit_regexp_ch)) {
            // look for an unprefixed unit
            var next = LookupUnit(token);
            var op = ' ';
            // if not found...
            if (! next) {
                // look for a prefixed unit
                var prefixunit = LookupPrefixedUnit(token);
                next = prefixunit[0];
                op = '~';
                result = CleanAndPush(stack, result, op, next);
                next = prefixunit[1];
            }
            if (next.categories.includes("Warn_angle")) {
                cycle_warn = true;
            }
            result = CleanAndPush(stack, result, op, next);

        // otherwise, if the token is an arithmetic operator...
        } else if (prec.hasOwnProperty(token)) {
            // operator
            if (result == null) {
                if (token == '+') {
                    // unary +
                    result = Value("0");
                    token = '>';
                } else if (token == '-') {
                    // unary -
                    result = Value("0");
                    token = '<';
                } else {
                    throw "expected a value before " + token;
                }
            }
            result = CleanAndPush(stack, result, token, null);

        } else {
            throw "bad token " + token;
        }
    }

    if (result == null && token != '?') {
        throw "missing expression";
    }

    // finalize the stack, popping all remaining operations
    result = CleanAndPush(stack, result, "zz", null);
    assert(! stack.length);

    return result;
}

// simplify an equation interpretation
function Simplify(interpretation)
{
    // XXX -- alternate parens; remove redundant parens
    if (interpretation[0] == '(' && MatchParen(interpretation, 0) == interpretation.length-1) {
        interpretation = interpretation.slice(1, interpretation.length-1);
    }
    return interpretation.replace(/[{]/g, "(").replace(/[}]/g, ")");
}

// *** expression alternation *********************************************************************

// expand a free unit to singular form(s)
function Singulars(name)
{
    var names = [name];
    if (name.match(/..s$/)) {
        if (name.match(/.ves$/)) {
            names.push(name.replace(/ves$/, "f"));
            names.push(name.replace(/ves$/, "fe"));
        } else if (name.match(/.ies$/)) {
            names.push(name.replace(/ies$/, "y"));
        } else if (name.match(/.(s|sh|ch|x|z)es$/)) {
            names.push(name.replace(/es$/, ""));
        } else {
            names.push(name.replace(/s$/, ""));
        }
    }
    return names;
}

// compare a possibly prefix or plural unit to a singular unit name from the database
function MatchPrefixPlural(name, i, j, search, searchremain)
{
    var singular = units[i].names[j];
    if (name == singular || (search && singular.toLowerCase().match("^" + name + (searchremain ? "" : "|_" + name + "|" + name + "$|" + name + "_")))) {
        return true;
    }
    if (units[i].pluralizables == null || ! units[i].pluralizables[j] || name[name.length-1] != 's' || search) {
        return false;
    }
    if (singular.match(/.f$/)) {
        if (name.replace(/ves$/, "f") == singular) {
            return true;
        }
    }
    if (singular.match(/.fe$/)) {
        if (name.replace(/ves$/, "fe") == singular) {
            return true;
        }
    }
    if (singular.match(/.y$/)) {
        if (name.replace(/ies$/, "y") == singular) {
            return true;
        }
    }
    if (singular.match(/(s|sh|ch|x|z)$/)) {
        if (name.replace(/es$/, "") == singular) {
            return true;
        }
    }
    if (name.replace(/s$/, "") == singular) {
        return true;
    }
    return false;
}

// return all the primary and secondary units that match a name
// XXX -- figure out how to factor this with the other Lookup functions!
function LookupUnits(name, prefixable, search)
{
    var j;
    var unit;
    var more = [];

    // if this is a precomputed unit to make loading faster
    if (name[0] == 'x' && name.match(/^xx[0-9]/)) {
        // no need to search, just return the unit
        more.push(name);
    } else {
        // check for a unit
        var name2;
        if (search) {
            name2 = name.toLowerCase();
        } else {
            name2 = name;
        }
        
        // for all units...
        for (var i = 0; i < units.length; i++) {
            unit = units[i];
            // if we are not looking only for prefixable units or the unit actually is prefixable...
            if (! prefixable || unit.prefixable) {
                // for all appropriate unit names...
                for (j = 0; j < unit.names.length; j++) {
                    // if the unit name matches, by prefix or by plural...
                    if ((name2[0] == unit.names[j][0] || search) && MatchPrefixPlural(name2, i, j, search, false)) {
                        // record a matching unit
                        if (search) {
                            more.push(unit.names[j]);
                        } else {
                            // use a precomputed unit to make subsequent searching faster
                            more.push("xx"+i);
                        }
                    }
                    if (unit.type == "PREFIX") {
                        break;
                    }
                }
            }
        }

        // check for a prefix and a unit

        // for all unit names...
        for (var ii = 0; ii < units.length; ii++) {
            unit = units[ii];
            // if this is a prefix...
            if (unit.type == "PREFIX") {
                var storage = unit.names[0].slice(2) == "bi";  // storage prefix
                // for all prefix names...
                for (var jj = 0; jj < unit.names.length; jj++) {
                    var prefix = unit.names[jj];
                    // if the specified name matches the prefix...
                    if (name[0] == prefix[0] && name.indexOf(prefix) == 0 && name.length > prefix.length) {
                        // prefix match
                        var remain = name2.slice(prefix.length);
                        // for all unit names...
                        for (i = 0; i < units.length; i++) {
                            var unit2 = units[i];
                            // if this unit is prefixable...
                            if (unit2.prefixable) {
                                if (storage && (unit2.exponents.length < storagebase || unit2.exponents[storagebase] == 0)) {
                                    // not storage
                                    continue;
                                }
                                // for all unit names...
                                for (j = 0; j < unit2.names.length; j++) {
                                    // if the remainder of the specified name matches the unit, by prefix or by plural...
                                    if ((remain[0] == unit2.names[j][0] || search) && MatchPrefixPlural(remain, i, j, search, true)) {
                                        // record a matching prefix and unit
                                        if (search) {
                                            more.push(unit.names[jj]+unit2.names[j]);
                                        } else {
                                            // use a precomputed unit to make subsequent searching faster
                                            more.push("xx"+ii + '~' + "xx"+i);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    // if we found one or more interpretations of the unit...
    if (more.length) {
        return more;
    }

    if (! evaluating) {
        throw "undefined unit " + name;
    }

    // define a free unit to use for the remainder of the expression
    unit = DefineBaseUnit(Singulars(name), true);
    return [unit.names[0]];
}

// call EvaluateTokens() for each possible alternation of tokens at or beyond n
function AlternateTokens(tokens, n)
{
    // for each token past where our callers have already alternated...
    var j;
    var subtokens;
    for (var i = n; i < tokens.length; i++) {
        // if we are alternating...
        if (tokens[i] == ';') {
            // solve by dimensional analysis alternation
            subtokens = tokens.slice(0);
            // for each alternate operator of ';'...
            for (j = 0; j < semicolon_alternates.length; j++) {
                subtokens[i] = semicolon_alternates[j];
                // recurse for remaining tokens
                AlternateTokens(subtokens, i+1);
            }
            return;
        } else if (tokens[i][0].match(unit_regexp_ch) && ! functions.hasOwnProperty(tokens[i])) {
            // ambiguous unit names alternation
            var spliced = false;
            subtokens = tokens.slice(0);
            var prefixable = i && tokens[i-1] == '~';
            // look up all interpretations of the unit
            var ambiguous = LookupUnits(tokens[i], prefixable, false);
            // for each interpretation of the unit...
            for (j = 0; j < ambiguous.length; j++) {
                // if this is a prefixed unit...
                if (ambiguous[j].match('~')) {
                    // split the unit into prefix and unit
                    var prefixunit = ambiguous[j].split('~');
                    if (! spliced) {
                        // grow the subtokens array once as needed
                        subtokens.splice(i, 0, prefixunit[0], '~');
                        spliced = true;
                    } else {
                        subtokens[i] = prefixunit[0];
                    }
                    subtokens[i+2] = prefixunit[1];
                } else {
                    subtokens[i] = ambiguous[j];
                }
                // recurse for remaining tokens
                AlternateTokens(subtokens, i+1);
            }
            return;
        }
    }

    try {
        // evaluate a single expression in an array of tokens and return a single result
        var result = EvaluateTokens(tokens);

        // check if the evaluation resulted in a dimensionless exponent beyond PI and RADIAN
        if (evaluating) {
            for (j = result.exponents.length-1; j >= 2; j--) {
                if (result.exponents[j]) {
                    break;
                }
            }
        } else {
            j = -1;
        }
        // if the evaluation resulted in a dimensionless exponent...
        if (j <= 1) {
            if (! result.PiAnalysis()) {
                throw "unexpected exponents of pi and radian; use pi_as_number or pin to escape";  //OK
            }

            // dimensionless results are top priority
            results.push(result);

        // otherwise, if the evaluation resulted in a mismatch of non-free units...
        } else if (j < freebaseunit) {
            // second priority are mismatches or SI or dimension calculations

            var strings = [];
            var question = tokens.indexOf('?');

            // if "expression ? unit" was entered...
            if (question != -1 && tokens.length > question+1) {
                // the user requested a unit and we mismatched; show what was missing as "1/dimension"
                strings = result.Dimension(question != -1);

            // otherwise, if "expression ?" was entered...
            } else if (question != -1) {
                // the user requested an SI result; show the SI result as "coefficient dimension"
                results = results.concat(result.SI());

            // "expression" was entered...
            } else {
                // the user requested a dimension; show what was evaluated as "dimension"
                strings = result.Dimension(question != -1);
            }

            // record the result as a mismatch
            // XXX -- generate merged mismatches and interpretations
            for (var k = 0; k < strings.length; k++) {
                if (! mismatches.includes(strings[k])) {
                    if (! defining) {
                        mismatches.push(strings[k]);
                    }
                }
            }

        // third priority are errors
        } else {
            // the evaluation resulted in a mismatch of a free unit
            if (! errors.includes("uncanceled free unit " + bases[j].names[0])) {
                errors.push("uncanceled free unit " + bases[j].names[0]);
            }
        }
    } catch (error) {
        if (! errors.includes(error)) {
            errors.push(error);
        }
    }
}

// *** command line *******************************************************************************

// tokenize a command line
function TokenizeLine(input)
{
    var test = input.match(/^TEST/);
    if (! test) {
        // remove comments except for TEST lines
        input = input.replace(/[#|].*/, "").trim();
    }

    var token;
    var tokens = [];
    var equal = false;
    var question = false;
    // for all letters in the command line...
    for (var i = 0; i < input.length; i++) {
        var ch = input[i];

        // if the letter is the start of a numeric value...
        if (ch.match(value_regexp_ch)) {
            // value
            token = input.slice(i).match(value_regexp_head)[0];
            i += token.length-1;

        // otherwise, if the letter is the start of a symbolic unit (or function call name)...
        } else if (ch.match(unit_regexp_ch)) {
            // unit
            token = input.slice(i).match(unit_regexp_head)[0];
            i += token.length-1;

        // otherwise, if the letter is an arithmetic operator...
        } else if (ch.match(operator_regexp_ch)) {
            // operator
            token = ch;
            if (ch == '=') {
                if (equal && ! test) {
                    throw "= may only occur once";
                }
                equal = true;
            }
            if (ch == '?') {
                if (question) {
                    throw "? may only occur once";
                }
                question = true;
            }
        } else if (ch == ' ') {
            continue;
        } else {
            throw "token error " + ch;
        }
        tokens.push(token);
    }

    return tokens;
}

// parse and run a command line
function ParseTokens(tokens, line)
{
    var i;
    var j;
    var k;
    var unit;
    if (tokens.length) {
        // if we are defining a base unit...
        if (tokens[0] == "BASE") {
            if (tokens.length != 2) {
                throw "missing unit";
            }
            DefineBaseUnit([tokens[1]], false);

        // otherwise, if we are defining a category...
        } else if (tokens[0] == "CATEGORY") {
            if (tokens.length != 2) {
                throw "missing category";
            }
            if (all_categories.includes(tokens[1])) {
                throw "duplicate category";
            }
            all_categories.push(tokens[1]);

        // otherwise, if we are pushing a category...
        } else if (tokens[0] == "___PUSH") {
            for (i = 1; i < tokens.length; i++) {
                if (tokens[i] != ',') {
                    if (! all_categories.includes(tokens[i]) && ! LookupUnit(tokens[i])) {
                        throw "undefined category " + tokens[i];
                    }
                    if (open_categories.includes(tokens[i])) {
                        throw "category already pushed " + tokens[i];
                    }
                    open_categories.push(tokens[i]);
                }
            }

        // otherwise, if we are popping a category...
        } else if (tokens[0] == "___POP") {
            for (i = 1; i < tokens.length; i++) {
                if (tokens[i] != ',') {
                    if ((j = open_categories.indexOf(tokens[i])) == -1) {
                        throw "category not pushed " + tokens[i];
                    }
                    open_categories.splice(j, 1);
                }
            }

        // otherwise, if we are verifying no categories are pushed...
        } else if (tokens[0] == "___VERIFY") {
            if (open_categories.length) {
                throw "categories pushed: " + open_categories.toString();
            }

        // otherwise, if we are running test code...
        } else if (tokens[0] == "TEST") {
            if (tokens[1] == "categories") {
                document.getElementById("equation").value = "";
                Units();
            } else if (tokens[1] == "byname") {
                document.getElementById("equation").value = tokens[2];
                Units();
            } else if (tokens[1] == "bycategory") {
                // XXX -- how to test this thru UI hyperlink?
                ShowUnitsByCategory(tokens[2], false);
            } else if (tokens[1] == "bydimension") {
                // XXX -- how to test this thru UI hyperlink?
                ShowUnitsByCategory(tokens[2], true);
            } else if (tokens[1] == "details") {
                document.getElementById("equation").value = tokens[2];
                Details();
            } else if (tokens[1] == "throw") {
                throw "unknown test throw";
            } else {
                // remember this entire database test for later
                database_tests += line.replace(/^TEST */, "") + '\n';
            }

        // otherwise, if we are defining or undefining a unit...
        } else if ((k = tokens.indexOf('=')) != -1) {
            var type = null;
            var remainder;
            var unambiguous = false;
            if (tokens[0] == "AMBIGUOUS") {
                type = "DERIVED";
                remainder = line.replace(/^AMBIGUOUS/, "").trim();
                i = 1;
            } else if (tokens[0] == "DERIVED") {
                type = tokens[0];
                remainder = line.replace(/^DERIVED/, "").trim();
                i = 1;
                unambiguous = true;
            } else if (tokens[0] == "PREFIX") {
                type = tokens[0];
                remainder = line.replace(/^PREFIX/, "").trim();
                i = 1;
            } else {
                remainder = line.replace(/^ *[*]/, "").replace(/[+][=]/, '=').trim();
                i = 0;
            }
            var prefixable = tokens[i][0] == '*';
            var names = [];
            var pluralizables = [];
            var categories = open_categories.slice(0);

            var add = false;
            var remove = false;
            var stop = k;
            if (! loading) {
                // if we are adding a definition or undefinition...
                if (k > 0 && tokens[k-1] == '+') {
                    add = true;
                    stop--;
                // otherwise, if we are removing a definition or undefinition...
                } else if (k > 0 && tokens[k-1] == '-') {
                    remove = true;
                    stop--;
                }
            }

            // gather categories and names...
            for (; i < tokens.length; i++) {
                if (i == stop) {
                    // end of names
                    break;
                } else if (tokens[i] == ':') {
                    // end of categories
                    for (j = 0; j < names.length; j++) {
                        if (categories.includes(names[j])) {
                            throw "category already pushed " + names[j];
                        }
                        if (! all_categories.includes(names[j]) && ! LookupUnit(names[j])) {
                            throw "undefined category " + names[j];
                        }
                        categories.push(names[j]);
                    }
                    names = [];
                    pluralizables = [];
                    continue;
                } else if (tokens[i] == ',') {
                    // next name or category
                    continue;
                } else if (tokens[i] == '*') {
                    // name is pluralizable
                    if (names.length) {
                        pluralizables[names.length-1] = true;
                    }
                } else if (tokens[i][0].match(unit_regexp_ch)) {
                    // record the name
                    names.push(tokens[i]);
                    pluralizables.push(false);
                } else {
                    throw "unexpected " + tokens[i];
                }
            }
            if (! i) {
                throw "missing name";
            }
            var subtokens = tokens.slice(k+1);

            // form the definition, including open and explicit categories
            var definition = prefixable?"*":"";
            if (type) {
                definition += type + " ";
            }
            if (categories.length) {
                definition += categories.join(",");
                definition += ":";
            }
            definition += remainder.replace(/[^:]*:/, "").trim();  // N.B. excludes prefixable and categories

            if (! loading && ! add && ! remove) {
                // for all units...
                // N.B. when undefining, we iterate from end to start so we can delete unit or name array elements and not affect subsequent indexes
                for (i = units.length-1; i >= 0; i--) {
                    // if the unit is not a base/derived/ambiguous/prefix unit...
                    if (units[i].type == null) {
                        // for all unit names...
                        for (j = units[i].names.length-1; j >= 0; j--) {
                            // for all names being undefined...
                            for (k = 0; k < names.length; k++) {
                                // if the unit name matches...
                                if (units[i].names[j] == names[k]) {
                                    // delete the unit name!
                                    units[i].names.splice(j, 1);
                                    units[i].pluralizables.splice(j, 1);
                                }
                            }
                            // if we deleted all names from a unit...
                            if (units[i].names.length == 0) {
                                // delete the unit itself!
                                units.splice(i, 1);
                            }
                        }
                    }
                }
                undefines = true;
            }

            // if we have an expression...
            if (k+1 < tokens.length) {
                undefines = false;
                // if we are loading the database...
                if (loading) {
                    deriving = (type == "DERIVED");
                    try {
                        // evaluate a single interpretation to be quick
                        results.push(EvaluateTokens(subtokens));
                        if (deriving) {
                            // XXX -- how can we test this after load?
                            var ambiguous = results[0].Ambiguous();
                            if (unambiguous && ambiguous) {
                                throw "ambiguous derived unit " + names[0] + " with " + ambiguous.names[0];
                            } else if (! unambiguous && ! ambiguous) {
                                throw "unambiguous ambiguous unit " + names[0];
                            }
                        }
                    } catch (error) {
                        if (! errors.includes(error)) {
                            errors.push(error);
                        }
                    } finally {
                        deriving = false;
                    }
                } else {
                    defining = true;
                    try {
                        // evaluate all interpretations to be thorough
                        AlternateTokens(subtokens, 0);
                    } finally {
                        defining = false;
                    }
                }

                // for all results...
                for (var r = 0; r < results.length; r++) {
                    if (remove) {
                        // undefine an existing unit
                        // N.B. when undefining, we iterate from end to start so we can delete unit or name array elements and not affect subsequent indexes
                        for (i = units.length-1; i >= 0; i--) {
                            // if the unit is not a base/derived/ambiguous/prefix unit...
                            if (units[i].type == null) {
                                // for all unit names...
                                for (j = units[i].names.length-1; j >= 0; j--) {
                                    // for all names being undefined...
                                    for (k = 0; k < names.length; k++) {
                                        // if the unit name matches and the definition matches...
                                        if (units[i].names[j] == names[k] && units[i].Equal(results[r])) {
                                            // delete the unit name!
                                            units[i].names.splice(j, 1);
                                            units[i].pluralizables.splice(j, 1);
                                        }
                                    }
                                    // if we deleted all names from a unit...
                                    if (units[i].names.length == 0) {
                                        // delete the unit itself!
                                        units.splice(i, 1);
                                    }
                                }
                            }
                        }
                        undefines = true;
                    } else {
                        // define a new unit!
                        unit = new Unit(names, pluralizables, results[r].coefficient, results[r].exponents, type, prefixable, categories, definition);
                        // if we are not loading the database...
                        if (! loading) {
                            if (! mismatches.includes("> " + Simplify(results[r].interpretation))) {
                                // record the interpretation of the definition
                                mismatches.push("> " + Simplify(results[r].interpretation));
                            }
                        }
                        Object.freeze(unit);
                        units.push(unit);
                        defines = true;
                    }
                }
                if (defines || undefines) {
                    results = [];
                }
            }

        } else {
            // we are evaluating an expression with free units
            evaluating = true;
            freebaseunit = nextbaseunit;
            var length = units.length;

            try {
                // evaluate all interpretations to be thorough
                AlternateTokens(tokens, 0);
            } finally {
                // discard free units
                nextbaseunit = freebaseunit;
                while (units.length > length) {
                    units.pop();
                }
                evaluating = false;
            }
        }
    }
}

// load the units database
function LoadDatabase(database)
{
    open_categories = [];

    // split the database into lines
    var lines = database.split(/[\r\n]+/);

    // for each line of the database...
    for (var i = 0; i < lines.length; i++) {
        // tokenize, parse, and run the command line
        //console.log(lines[i]);
        results = [];
        mismatches = [];
        errors = [];
        defines = false;
        undefines = false;
        try {
            ParseTokens(TokenizeLine(lines[i]), lines[i]);
        } catch (error) {
            throw "exception: " + lines[i] + " : " + error;
        }

        if (results.length) {
            throw "unexpected result: " + lines[i] + " : " + (results[0].coefficient.toPrecision(6) * 1);  // N.B. * 1 removes trailing 0's from toPrecision();
        }
        if (mismatches.length) {
            for (var j = mismatches.length-1; j >= 0; j--) {
                if (mismatches[j].match(/^[>] /)) {
                    mismatches.splice(j, 1);
                }
            }
            if (mismatches.length) {
                throw "unexpected mismatch: " + lines[i] + " : " + mismatches.toString();
            }
        }
        if (errors.length) {
            throw "unexpected error: " + lines[i] + " : " + errors.toString();
        }
    }

    // identify our "special" base units
    for (i = 0; i < bases.length; i++) {
        if (bases[i].names[0] == "STORAGE") {
            // we only allow binary prefixes on storage units
            storagebase = i;
        }
    }

    if (open_categories.length) {
        throw "categories not popped: " + open_categories.toString();
    }
}

// low quality results contain mix of angles and numbers or auto-inversion; high quality results do not contain solve by dimensional analysis ^-1
function Quality(interpretation)
{
    if (interpretation.match(/_as_number/) || interpretation.match(/(_as_f|[[]F)requency/)) {
        if (interpretation.match(/_as_angle/) || interpretation.match(/(_as_a|[[]A)ngular_velocity/)) {
            return 0.0;  // low
        }
    }
    if (interpretation.match(/ [^] [-]1 [?]/)) {
        return 0.1;  // low
    }
    if (interpretation.match(/[^][-]1/)) {
        return 1;  // medium
    }
    return 2;  // high
}

// run a command line and return the output as an array of strings and a success bool
function RunLine(line)
{
    var output = [];
    var success = true;

    // capture the result dimension
    var dimension = "";
    var ncline = line.replace(/[#].*/, "");
    var question = ncline.indexOf('?');
    if (question != -1) {
        // normal requests get dimension from command line, up to the first unmatched close parenthesis
        dimension = ncline.slice(question+1);
        var i;
        var n = 0;
        for (i = 0; i < dimension.length; i++) {
            if (opens.indexOf(dimension[i]) != -1) {
                n++;
            } else if (closes.indexOf(dimension[i]) != -1) {
                if (! n) {
                    break;
                }
                n--;
            }
        }
        dimension = " " + dimension.slice(0, i);
    }

    // tokenize the command line
    results = [];
    mismatches = [];
    errors = [];
    defines = false;
    undefines = false;
    invert_warn = false;
    var tokens = TokenizeLine(line);

    // identify SI requests
    var si = false;
    if (tokens.length > 0 && tokens[tokens.length-1] == '?') {
        si = true;
    }

    // parse and run the command line
    ParseTokens(tokens, line);

    // if we got one or more valid (dimensionally consistent, and hence now dimensionless) results...
    if (results.length) {
        var j;
        var k;
        var answers = [];
        var interpretations = [];

        // format the results we will output, appending the captured dimension we parsed from the command line
        for (j = 0; j < results.length; j++) {
            if (si) {
                // SI requests get dimension from result
                dimension = " " + results[j].dimension;
            }
            var string = "= " + (results[j].coefficient.toPrecision(6) * 1) + dimension;  // N.B. * 1 removes trailing 0's from toPrecision()
            var answer = answers.indexOf(string);
            if (answer == -1) {
                interpretations[answers.length] = [Simplify(results[j].interpretation)];
                answers.push(string);
            } else {
                // sort interpretations by answer
                if (! interpretations[answer].includes(Simplify(results[j].interpretation))) {
                    interpretations[answer].push(Simplify(results[j].interpretation));
                }
            }
        }

        var current;
        var minimum = 0;
        for (j = 0; j < answers.length; j++) {
            for (k = 0; k < interpretations[j].length; k++) {
                if ((current = Quality(interpretations[j][k])) > minimum) {
                    // we won't print low quality results at all if there are any non-low quality results
                    minimum = Math.min(current, 1);
                }
            }
        }

        // generate merged answers and interpretations
        for (j = 0; j < answers.length; j++) {
            var best = 0;
            for (k = 0; k < interpretations[j].length; k++) {
                if ((current = Quality(interpretations[j][k])) > best) {
                    // we only print the best quality interpretations for a given result
                    best = current;
                }
            }
            if (best >= minimum) {
                for (k = 0; k < interpretations[j].length; k++) {
                    if (Quality(interpretations[j][k]) == best) {
                        if (interpretations[j][k].match(/ [^] [-]1 [?]/)) {
                            // we auto-inverted left-hand-side
                            invert_warn = true;
                        }
                        output.push("> " + interpretations[j][k]);
                    }
                }
                output.push(answers[j]);
            }
        }

    // otherwise, if we defined a unit or got one or more dimensional mismatches (or SI results)...
    } else if (defines || mismatches.length) {
        // use the mismatches (or SI results) as the results we will output
        output = mismatches;
        if (defines) {
            output.push("defined");
        }

    // otherwise, if we undefined units...
    } else if (undefines) {
        output = ["undefined"];

    // otherwise, if we caught one or more exceptions as errors...
    } else if (errors.length) {
        output = errors;
        success = false;
    }

    // return an array of strings and a success bool
    return { output:output, success:success };
}
</script>

<script type="text/javascript" src="custom.js">
    // custom=...
</script>

<script>

// *** html elements ******************************************************************************

// persist new results, scroll the page to the equation line, and set equation focus
function Scroll(noscroll)
{
    if (testing) {
        return;
    }

    // store our results history
    var save = document.getElementById("results").innerHTML.trim();  // XXX -- why space when empty?
    localStorage["calchemy.results"] = save;

    // enable the Delete All button if there are chunks to delete
    document.getElementById("all").disabled = ! save.length;

    // if we're scrolling...
    if (noscroll != true) {
        // scroll the equation line into view and set the focus
        document.getElementById("bottom").scrollIntoView();
        document.getElementById("equation").focus();
        // if needed, scroll us all the way left
        // N.B. some browsers hide our margin otherwise and it looks bad
        var x = window.scrollX, y = window.scrollY;
        if (x < 100) {
            window.scrollTo(0, y);
        }
    }
}

// convert text to breakable text for the history list
// XXX -- why don't tables break anywhere on phone?  Just enter long numeric string. :-(
function Break(output)
{
    // allow breaks periodically
    return output.match(/(.{1,20})/g).join("<wbr>");
}

// convert text to hyperlinked html for the history list
function History(text)
{
    var html = Break(text);
    if (html.match(/[#]/)) {
        html = html.replace(/[#]/, "<i class='i4'>#").replace(/$/, "</i>");
    }
    return "<a href=\"javascript:Hyperlink('" + text.replace(/^= /, "") + "')\">" + html + "</a>";
}

var lasttag = "";

// append a tagged html chunk to allow results to be deleted
function Chunk(label, result)
{
    // create a random tag if a label was not specified explicitly
    var tag;
    if (label == null) {
        tag = window.crypto.getRandomValues(new Uint32Array(4)).join('-');
        label = "";
    } else {
        tag = label.replace(/ /g, "");
        label = label + " ";
    }
    Delete(tag);
    if (result == undefined) {
        result = "";
    }

    // create the chunk as a searchable comment preceded by a horizontal line and followed by a table with a delete button to the right
    var hrtag = "<hr><!--" + tag + "-->";  // N.B. duplicated below
    var head = "<table><tr><td>";
    var button = "</td><td class='td3'><button type='button' style='margin: 0px;' onclick='Delete(\"" + tag + "\")'>Delete</button>";
    var tail = "</td></tr></table>";

    document.getElementById("results").innerHTML += hrtag + head + label + result + button + tail;
    first = true;
    if (lasttag == "") {
        lasttag = tag;
    }
}

// the user clicked a Delete button; delete tagged html results
function Delete(tag)
{
    if (tag == "all") {
        // delete all chunks
        document.getElementById("results").innerHTML = "";
    } else {
        // find the requested chunk in the results
        var head;
        var mid;
        var tail;
        var orig = document.getElementById("results").innerHTML;
        var hrtag = "<hr><!--" + tag + "-->";  // N.B. duplicated above
        var index = orig.indexOf(hrtag);
        if (index != -1) {
            // delete everything up to the next chunk
            head = orig.slice(0, index);
            mid = orig.slice(index + hrtag.length);
            var nexthr = "<hr>";
            index = mid.indexOf(nexthr);
            if (index != -1) {
                tail = mid.slice(index);
            } else {
                tail = "";
            }
            // update the results
            document.getElementById("results").innerHTML = head.trim() + " " + tail.trim();
            cursor = 0;
        }
    }

    // reset url
    window.history.pushState("", "", window.location.href.replace(/[?#].*/, ""));
    Scroll(true);
}

// snoop the test results and delete tagged html results
function SnoopAndDelete(tag)
{
    // find the requested chunk in the results
    var head;
    var mid;
    var orig = document.getElementById("results").innerHTML;
    var hrtag = "<hr><!--" + tag + "-->";  // N.B. duplicated above
    var index = orig.indexOf(hrtag);
    if (index == -1) {
        return [""];
    }

    // delete everything up to the next chunk
    head = orig.slice(0, index);
    mid = orig.slice(index + hrtag.length);

    // update the results
    document.getElementById("results").innerHTML = head.trim();

    // return the snoop
    var lines = mid.split("<br>");
    var snoops = [];
    for (var i = 0; i < lines.length; i++) {
        var snoop = lines[i].replace(/<wbr>/g, "").replace(/<\/?[^>]+>/g, " ").replace(/ Delete /g, " ");
        if (snoop.trim().length) {
            snoops.push(snoop);
        }
    }
    return snoops;
}

function LoadRuntimeDatabase(name, text)
{
    try {
        var number = units.length;
        LoadDatabase(text);
        number = units.length - number;
        Chunk(name, "loaded " + number + " units");
    } catch (error) {
        // append a deletable chunk with any errors
        Chunk(name, error);
    } finally {
        offset_warn = false;
        cycle_warn = false;
    }
    Scroll();
}

// the user loaded the webpage; initialize the units database
function Body()
{
    try {
        // capture our query string
        var url = document.URL;

        // recall our results history
        var temp = localStorage["calchemy.results"];
        document.getElementById("results").innerHTML = temp != undefined ? temp : "";

        var number = units.length;

        // load the units database
        loading = true;
        LoadDatabase(database);
        loading = false;

        number = units.length - number;
        Chunk("database", "loaded " + number + " units");

        if (custom != null) {
            number = units.length;

            // load custom units
            LoadDatabase(custom);

            number = units.length - number;
            Chunk("custom", "loaded " + number + " units");
        }

        // if we have a query string...
        var index = url.indexOf('?');
        if (index != -1) {
            offset_warn = false;
            cycle_warn = false;

            // pretend the user entered the query string thru the UI
            document.getElementById("equation").value = window.unescape(url.slice(index+1));
            Enter();

            // reset url
            window.history.pushState("", "", window.location.href.replace(/[?#].*/, ""));
        }
    } catch (error) {
        document.getElementById("status").innerHTML += error;
    } finally {
        offset_warn = false;
        cycle_warn = false;
    }

    // handle key presses in the user equation
    document.body.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            // enter -- run the command line
            event.preventDefault();
            document.getElementById("enter").click();
        }
        if (event.keyCode === 40) {
            // down arrow -- recall a newer command line
            event.preventDefault();
            UpDown(false);
        }
        if (event.keyCode === 38) {
            // up arrow -- recall an older command line
            event.preventDefault();
            UpDown(true);
        }
    });

    // handle database load events
    document.getElementById("file").addEventListener('input', function() {
        var file = document.getElementById("file").files[0];
        var reader = new FileReader();
        reader.addEventListener('load', function(e) {
            var text = e.target.result;
            try {
                LoadRuntimeDatabase(file.name, text);
            } catch (error) {
                // append a deletable chunk with any errors
                Chunk(file.name, error);
            }
        });
        reader.readAsText(file);
    });

    Scroll();
}

// the user clicked the Enter button; run the user command line
function Enter()
{
    var success = false;

    try {
        // get the user command line split by '&'
        var equation = document.getElementById("equation").value;
        var lines = equation.split('&');
        var urls = [];
        var htmls = [];

        for (var k = 0; k < lines.length; k++) {
            // parse the requested dimension from the command line
            var line = lines[k];

            // run the command line
            var results = RunLine(line);
            success = results.success;
            var output = results.output;

            // transform the output into hyperlinked html
            var html = "";
            for (var i = 0; i < output.length; i++) {
                if (output[i].match(/^= /)) {
                    html += "<br>" + History(output[i]);
                } else if (output[i].match(/^[>] /)) {
                    html += "<br><i>" + Break(output[i]) + "</i>";
                } else {
                    html += "<br>" + output[i];
                }
            }

            // if we auto-inverted left-hand-side...
            if (invert_warn) {
                html += "<br> Caution: Calculation auto-inverted left-hand-side.";
            }

            // if we accessed offset temperature units...
            if (offset_warn && ! offset_warned) {
                html += "<br> Caution: Calculation involves offset temperature units; see Calchemy Help.";
                offset_warned = true;
            }

            // if we accessed units of cycle or revolution...
            if (cycle_warn && ! cycle_warned) {
                html += "<br> Caution: Calculation involves units of cycle or revolution; see Calchemy Help.";
                cycle_warned = true;
            }

            // record output
            if (lines.length > 1 && line.trim().length && success && ! testing) {
                htmls.push("<br>" + History(line) + html);
            } else if (html.length) {
                htmls.push(html);
            }

            urls.push(window.escape(line));

            // stop at first error
            if (! success) {
                break;
            }

            Clear();
        }

        // append a deletable chunk to the results list with the results
        if (equation.length && success && ! testing) {
            Chunk(null, History(equation) + htmls.join(' '));
            window.history.pushState("", "", window.location.href.replace(/[?#].*/, "") + '?' + urls.join('&'));
        } else if (htmls.length) {
            // N.B. if there is no new output we leave output from before TEST available
            Chunk(null, htmls.join(' '));
        }
    } catch (error) {
        Chunk(null, error);
    }
    Scroll();

    return success;
}

var first = true;
var cursor = 0;

// the user typed up-arrow or down-arrow to recall an older or newer command line
function UpDown(up)
{
    // get the list of lines and hyperlinks from the results history
    var html = document.getElementById("results").innerHTML;
    var lines = html.split(/[<>]+/);
    var links = [];
    for (var i = 0; i < lines.length; i++) {
        if (lines[i].match(/javascript:Hyperlink/i)) {
            links.push(lines[i].replace(/.*javascript[:]Hyperlink.[']/i, "").replace(/['].*/, ""));
        }
    }
    if (first && up) {
        // an initial up-arrow recalls the last hyperlink from the results history
        cursor = 0;
    }
    if (links.length) {
        // recall the requested hyperlink from the results history to the equation line
        if (up) {
            // older
            cursor = (cursor+links.length-1)%links.length;
        } else {
            // newer
            cursor = (cursor+1)%links.length;
        }
        document.getElementById("equation").value = links[cursor].replace(/&amp;/g, '&');
        first = false;
    }
    Scroll();
}

// the user clicked the Clear button; clear the user equation
function Clear()
{
    // reset url
    window.history.pushState("", "", window.location.href.replace(/[?#].*/, ""));

    document.getElementById("equation").value = "";
    Scroll();
}

// the user clicked a hyperlink; enter text into the user equation, possibly replacing the word at the cursor
function Hyperlink(string)
{
    var equation = document.getElementById("equation");
    var start = equation.selectionStart;
    var end = equation.selectionEnd;
    // if we are properly inside a word...
    if (start > 0 && equation.value.slice(start-1, end).match(unit_regexp_all) || end < equation.value.length-1 && equation.value.slice(start, end+1).match(unit_regexp_all)) {
        // find the start and end of the word at the cursor
        var match = equation.value.slice(0, start).match(unit_regexp_tail);
        if (match) {
            start -= match[0].length;
        }
        match = equation.value.slice(end).match(unit_regexp_head);
        if (match) {
            end += match[0].length;
        }
        // replace the word at the cursor with the hyperlinked string
        equation.value = equation.value.slice(0, start) + string + equation.value.slice(end);
    } else {
        // insert the hyperlinked string at the cursor
        equation.value = equation.value.slice(0, start) + string + equation.value.slice(end);
    }
    // update the selection
    equation.selectionStart = equation.selectionEnd = start + string.length;
    Scroll();
}

// show details for a unit in the user equation
function ShowUnitsDetails(name)
{
    // find all interpretations of the unit
    var more = LookupUnits(name, false, false);

    // for each interpretation of the unit...
    var html = "";
    for (var i = 0; i < more.length; i++) {
        // if the unit is prefixed...
        if (more[i].match('~')) {
            // format the prefix definition and the unit definition side-by-side
            // N.B. the unit definition begins with a '*', which we use to represent the multiplication!
            var prefixunit = more[i].split('~');
            html += "<br>" + LookupUnit(prefixunit[0]).definition + LookupUnit(prefixunit[1]).definition;
        } else {
            // format the unit definition alone
            html += "<br>" + LookupUnit(more[i]).definition;
        }

        // append the dimension of the unit to the unit details
        var tokens = TokenizeLine(more[i]);
        var filter = EvaluateTokens(tokens);
        // XXX -- hack for now to ignore interpretations
        html += " " + filter.Dimension(false)[1];
    }

    // append a deletable chunk to the results list with the unit details
    Chunk("=== unit details " + name + " ===", html);
    Scroll();
}

// sort, stably folding upper/lower case
function Sort(array)
{
    array.sort(function(a, b) {
        var compare = a.toLowerCase().localeCompare(b.toLowerCase());
        return compare ? compare : a.localeCompare(b);
    });
}

// show units in a database category or dimension
function ShowUnitsByCategory(category, bydimension)  // or "All Units"
{
    var i, j;
    var names = [];
    if (bydimension != true) {
        // first look for category matches
        for (i = 0; i < units.length; i++) {
            if (! units[i].type || units[i].type == "PREFIX") {
                if (units[i].categories.includes(category)) {
                    for (j = 0; j < units[i].names.length; j++) {
                        if (! names.includes(units[i].names[j])) {
                            names.push(units[i].names[j]);
                        }
                    }
                }
            }
        }
    }

    if (! names.length) {
        // then look for dimension matches
        var filter = LookupUnit(category);
        if (filter || category == "All Units") {
            for (i = 0; i < units.length; i++) {
                if (! units[i].type) {
                    if (units[i].Compatible(filter, false)) {
                        for (j = 0; j < units[i].names.length; j++) {
                            if (! names.includes(units[i].names[j])) {
                                names.push(units[i].names[j]);
                            }
                        }
                    }
                }
            }
        }
    }

    // finally look for SI units
    for (i = 0; i < units.length; i++) {
        if (units[i].type == "DERIVED" && units[i].names[0] == category) {
            var name = units[i].definition.replace(/.*= */, "").replace(/ *[#].*/, "").trim();
            if (! names.includes(name)) {
                names.push(name);
            }
        }
    }

    // compute the list of hyperlinked units
    Sort(names);
    var html = "<br><div id='columns'>";
    for (i = 0; i < names.length; i++) {
        html += History(names[i]) + "<br>";
    }
    html += "</div>";

    // append a deletable chunk to the results list with the units list
    Chunk("=== units in category " + category + " ===", html);
    Scroll();
}

// show units that can match the unit in the user equation
function ShowUnitsByName(name)
{
    // find all units that match the name
    var i;
    var names = LookupUnits(name, false, true);
    var namesets = [];
    for (i = 0; i < names.length; i++) {
        if (! namesets.includes(names[i])) {
            namesets.push(names[i]);
        }
    }

    // compute the list of hyperlinked units
    Sort(namesets);
    var html = "<br><div id='columns'>";
    for (i = 0; i < namesets.length; i++) {
        html += History(namesets[i]) + "<br>";
    }
    html += "</div>";

    // append a deletable chunk to the results list with the units list
    Chunk("=== units by name " + name + " ===", html);
    Scroll();
}

// show database categories and dimensions
function ShowCategories()
{
    // compute the list of categories and dimensions
    var categories = [];
    for (var i = 0; i < units.length; i++) {
        for (var j = 0; j < units[i].categories.length; j++) {
            if (! categories.includes(units[i].categories[j])) {
                categories.push(units[i].categories[j]);
            }
        }
        if (units[i].type == "DERIVED") {
            if (! categories.includes(units[i].names[0])) {
                categories.push(units[i].names[0]);
            }
        }
    }

    // compute the list of hyperlinked categories and dimensions
    Sort(categories);
    var html = "<div id='columns'>";
    html += "<a href=\"javascript:ShowUnitsByCategory('All Units')\">All Units</a>";
    for (i = 0; i < categories.length; i++) {
        html += "<br>" + "<a href=\"javascript:ShowUnitsByCategory('" + categories[i] + "')\">" + categories[i] + "</a>";
    }
    html += "</div>";

    // append a deletable chunk to the results list with the categories list
    Chunk("=== unit categories ===", html);
    Scroll();
}

// return the word at the cursor
function Word(extended)
{
    var line = document.getElementById("equation").value;
    var start = document.getElementById("equation").selectionStart;
    var match = line.slice(start).match(extended?xunit_regexp_head:unit_regexp_head);
    if (match) {
        start += match[0].length;
    }
    line = line.slice(0, start);
    var word = line.match(extended?xunit_regexp_tail:unit_regexp_tail);
    if (word) {
        word = word[0];
        if (extended) {
            word = word.replace(/.*:/, "");
        }
    }
    return word;
}

// the user clicked the Find Units button; find units requested by the user
function Units()
{
    // if there is a word at the cursor...
    var word = Word(true);
    if (word) {
        var unit = LookupUnit(word);
        if (unit && unit.type) {
            // do a unit category search
            ShowUnitsByCategory(word);
        } else {
            // do a unit search
            ShowUnitsByName(word);
        }
    } else {
        // do a category search
        ShowCategories();
    }
    Scroll();
}

// the user clicked the Unit Details button; show unit details requested by the user
function Details()
{
    // if there is a word at the cursor...
    var word = Word(false);
    if (word) {
        // show unit details
        ShowUnitsDetails(word);
    }
    Scroll();
}

// the user clicked the Copy button; copy the history and equation to the clipboard
function Copy()
{
    var text = document.getElementById("results").innerText.replace(/[ \t][ \t]*/g, " ").replace(/ Delete$/gm, "") + "\n\n" + document.getElementById("equation").value;
    navigator.clipboard.writeText(text);
    Scroll();
}

// the user clicked the Paste button; paste the clipboard into the equation line up to the first error
function Paste()
{
    navigator.clipboard.readText().then((text) =>
    {
        // for each equation line in the clipboard...
        var lines = text.split(/[\r\n]+/);
        for (var i = 0; i < lines.length; i++) {
            if (! lines[i].match(/^[[>=]/) && ! lines[i].match(/^(un)?defined/) && ! lines[i].match(/^Caution/) && ! lines[i].match(/^Delete/) && ! lines[i].match(/^Mismatch/)) {
                // evaluate the equation line
                document.getElementById("equation").value = lines[i];
                // if the evaluation failed...
                if (! Enter()) {
                    // don't evaluate any more equation lines
                    break;
                }
            }
        }
    });
    Scroll();
}

var examples =`
    0.5 * 0.32 * d_air * (60 mph)^2 * 25 square feet ? lbf  # air drag force on car | = 77.7017 lbf
    77.7017 lbf * 60 mph ? hp  # power to overcome air drag force at speed | = 12.4323 hp
    2000 lbm * grav * 60 mph ? hp  # power to decelerate car at 1G | = 320 hp
    1/2 * 2000 lbm * ((60 mph)^2 - (55 mph)^2) / (5 sec) ? hp  # measured power drag on car | = 13.9795 hp
    13.9795 hp; 55 mph; hcv_gasoline*20% ? mpg # mpg estimation at 20% engine efficiency | = 35.88 mpg
    35.88 mpg ? km/l # fuel efficiency | = 15.2542 km/l
    1 cup * 4 gram/tsp ? lb  # weight of granulated sugar | = 0.423288 lb
    1/2 pi sqrt(23 millihenry * 10 microfarad) ? Hz  # frequency of LC oscillator | = 331.861 Hz
    60 PiB/month ? Gbps  # fast network bandwidth | = 205.644 Gbps
    3.4 mega byte / (1200 baud) ? hour  # slow network time | = 6.2963 hour
    20000 btu/hour; 80% * 14 megajoules/day/meter^2 ? ft^2  # solar collector size | = 486.71 ft^2
    2 packs; 30 rolls/pack; 425 sheets/roll; 40 sheets/poop; 1 poops/person/day; 3 persons ? months | = 6.9863 months
    pi * (0.25 inch)^2; 60 ft; 5 gal/min ? sec  # time for hot water to flow thru 1/2 inch pipe | = 7.34398 sec
    40 gal; 120 degF - 45 degF; 1 cal/(cc deltaC); 40000 btu/hr ? min  # water heater recovery time | = 37.5291 min
    10 mph * 30 feet * 10 gal/acre ? gal/min  # fertilizer flow rate on tractor swath | = 6.06061 gal/min
    30 ft * 20 meters ? acres # lot size | = 0.0451906 acres
    40 knot / (2500 rpm * 90%) ? inch/rev  # propeller pitch | = 21.604 inch/rev
    (3/4) cup * 1 cal/(cc deltaK) * (212 - 52) deltaF / (2 min + 4 sec) ? watt  # measured power of microwave oven | = 532.196 watt
    (50 ft * 30 ft * 0.75 inches/week) / (5 gal/min) ? hours/week  # lawn sprinkler time | = 2.33766 hours/week
    40 gal * 1 cal/(cc deltaK) * (140-45) deltaF / (40000 btu/hour) ? hour  # water heater recovery time | = 0.79228 hour
    45 hp; 2 pi 8000 rpm ? ft lb  # convert power to torque | = 29.5431 ft lb
    (3/(4 pi) * 1 gal)^(1/3) ? inches  # radius of a gallon sphere | = 3.80634 inches
    (1 gallon)^(1/3) ? inches  # width of a gallon cube | = 6.13579 inches
`;

// the user clicked the Examples button; show examples
function Examples()
{
    // get all the example lines, including blanks
    var lines = examples.split(/[\r\n]+/);
    var html = "";
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].replace(/[|].*/, "").trim();
        if (line.length) {
            html += "<br>" + History(line);
        }
    }

    // append a deletable chunk to the results list with the examples, replacing any existing examples chunk
    Chunk("=== examples ===", html);
    Scroll();
}

var preequations = `
    # equation support
    Cd = 1
    width = 1 Length
    height = 1 Length
    depth = 1 Length
    base = 1 Length
    radius = 1 Length
    f = 1/second
    omega = 1 radian/second
`;

var equations =`
    # Geometrical
    [width:Length] [height:Length] ? [Area]  # area of rectangle | = 1 [Area]
    (1/2) [base:Length] [height:Length] ? [Area]  # area of triangle | = 0.5 [Area]
    pi [radius:Length]^2 ? [Area]  # area of circle | = 3.14159 [Area]
    4 pi [radius:Length]^2 ? [Area]  # area of sphere | = 12.5664 [Area]
    [width:Length] [height:Length] [depth:Length] ? [Volume]  # volume of a rectangular prism | = 1000 [Volume]
    (1/3) [base:Length] [height:Length] [depth:Length] ? [Volume]  # volume of a pyramid | = 333.333 [Volume]
    pi [radius:Length]^2 [Length] ? [Volume]  # volume of cylinder | = 3141.59 [Volume]
    (4/3) pi [radius:Length]^3 ? [Volume]  # volume of sphere | = 4188.79 [Volume]
    sqrt([base:Length]^2 + [height:Length]^2) ? [Length]  # length of hypotenuse | = 1.41421 [Length]

    # Electrical
    [Current] [Resistance] ? [Voltage]  # ohm's law | = 1 [Voltage]
    [Current]^2 [Resistance] ? [Power]  # joule's law | = 1 [Power]
    [Voltage] [Current] ? [Power] | = 1 [Power]
    [Voltage]^2 / [Resistance] ? [Power] | = 1 [Power]
    [Resistance] + [Resistance] ? [Resistance]  # series resistors | = 2 [Resistance]
    1/(1/[Resistance] + 1/[Resistance]) ? [Resistance]  # parallel resistors | = 0.5 [Resistance]
    1/(1/[Capacitance] + 1/[Capacitance]) ? [Capacitance]  # series capacitors | = 0.5 [Capacitance]
    [Capacitance] + [Capacitance] ? [Capacitance]  # parallel capacitors | = 2 [Capacitance]
    0.5 [Capacitance] [Voltage]^2 ? [Energy]  # capacitor energy | = 0.5 [Energy]
    [Inductance] + [Inductance] ? [Inductance]  # series inductors | = 2 [Inductance]
    1/(1/[Inductance] + 1/[Inductance]) ? [Inductance]  # parallel inductors | = 0.5 [Inductance]
    0.5 [Inductance] [Current]^2 ? [Energy]  # inductor energy | = 0.5 [Energy]
    1/2 pi sqrt([Inductance] [Capacitance]) ? [f:Frequency]  # frequency of LC oscillator | = 0.159155 [f:Frequency]
    1/sqrt([Inductance] [Capacitance]) ? [omega:Angular_velocity]  # angular velocity of LC oscillator | = 1 [omega:Angular_velocity]

    # Mechanical
    0.5 [Mass] [Speed]^2 ? [Energy]  # kinetic energy | = 0.5 [Energy]
    [Mass] grav [height:Length] ? [Energy]  # potential energy | = 9.80665 [Energy]
    [Force] [Length] ? [Energy] | = 1 [Energy]
    [Force] [Speed] ? [Power] | = 1 [Power]
    [Energy] / [Time] ? [Power] | = 1 [Power]
    [omega:Angular_velocity] [Torque] ? [Power] | = 1 [Power]
    2 pi [f:Frequency] [Torque] ? [Power] | = 6.28319 [Power]
    [Stiffness] [Length] ? [Force] | = 1 [Force]
    [Stiffness] [Length]^2 ? [Energy] | = 1 [Energy]
    [Mass] [Acceleration] ? [Force]  # newton's second law | = 1 [Force]
    [Mass] [Acceleration] [Speed] ? [Power] | = 1 [Power]
    [Mass] [Acceleration] [Length] ? [Energy] | = 1 [Energy]
    [Mass] [Speed] ? [Momentum] | = 1 [Momentum]
    [Force] [radius:Length] ? [Torque] | = 1 [Torque]
    [omega:Angular_velocity] [radius:Length] ? [Speed] | = 1 [Speed]
    [omega:Angular_velocity]^2 [radius:Length] ? [Acceleration] | = 1 [Acceleration]

    # Fluid_mechanical
    [Density] grav [height:Length] ? [Pressure]  # static head pressure | = 9806.65 [Pressure]
    0.5 [Cd] [Density] [Speed]^2 [Area] ? [Force]  # dynamic drag force | = 500 [Force]
    0.5 [Cd] [Density] [Speed]^3 [Area] ? [Power]  # dynamic drag power | = 500 [Power]

    # Orbit_mechanical
    G [Mass] [Mass] / [radius:Length]^2 ? [Force]  # force of attraction | = 6.67259e-11 [Force]
    sqrt(2 G [Mass] / [radius:Length]) ? [Speed]  # escape speed | = 0.0000115521 [Speed]
    G [Mass] [Mass] / (2 [radius:Length]) ? [Energy]  # orbital kinetic energy | = 3.33629e-11 [Energy]
    -G [Mass] [Mass] / [radius:Length] ? [Energy]  # orbital potential energy | = -6.67259e-11 [Energy]

    # Nuclear
    [Mass] c^2 ? [Energy] | = 89875500000000000 [Energy]
`;

var postequations = `
    # equation support
    Cd =
    width =
    height =
    depth =
    base =
    radius =
    f =
    omega =
`;

// the user clicked an equation group; show equations
function EquationsByGroup(group)  // or "All Equations"
{
    var found = group == "All Equations";
    var lines = equations.split(/[\r\n]+/);
    var html = "";
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].replace(/[|].*/, "").trim();
        if (line.length) {
            if (group != "All Equations" && line[0] == '#') {
                found = line.replace(/[#] */, "") == group;
            } else {
                if (found) {
                    html += "<br>" + History(line.trim());
                }
            }
        }
    }

    // append a deletable chunk to the results list with the equations list
    Chunk("=== equations in group " + group + " ===", html);
    Scroll();
}

// the user clicked the Equations button; show equation groups
function Equations()
{
    var lines = equations.split(/[\r\n]+/);
    var html = "<br><a href=\"javascript:EquationsByGroup('All Equations')\">All Equations</a>";
    var groups = [];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (line[0] == '#') {
            groups.push(line.replace(/# */, ""));
        }
    }
    Sort(groups);
    for (i = 0; i < groups.length; i++) {
        html += "<br>" + "<a href=\"javascript:EquationsByGroup('" + groups[i] + "')\">" + groups[i] + "</a>";
    }

    // append a deletable chunk to the results list with the equation groups list
    Chunk("=== equation groups ===", html);
    Scroll();
}

// load units from a local file
function LoadLocal()
{
    document.getElementById("file").click();
}

var remotes = [ "elements.js", "flexcase.js", "materials.js", "solarsys.js" ];

// load units from where calchemy.html was found
function LoadRemote(file)
{
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.src = file;
    script.type = 'text/javascript';
    head.append(script);
}

// the user clicked the Load button; load optional units
function Load()
{
    // compute the list of hyperlinked databases
    var html = "<br><a href=\"javascript:LoadLocal()\">Local Database</a>";
    for (var i = 0; i < remotes.length; i++) {
        html += "<br>" + "<a href=\"javascript:LoadRemote('" + remotes[i] + "')\">" + remotes[i] + "</a>";
    }

    // append a deletable chunk to the results list with the categories list
    Chunk("=== unit databases ===", html);
    Scroll();
}

var tests =`
    # values and units
    |
    .3 | = 0.3
    0.3 | = 0.3
    3e-1 | = 0.3
    3e-1 | = 0.3
    300 | = 300
    3e2 | = 300
    $ ? $ | = 1 $
    % | = 0.01
    .444444444444 | = 0.444444
    .555555555555 | = 0.555556
    meter?metre | = 1 metre
    speed_of_light ? c | = 1 c
    metre?meter | = 1 meter
    c ? speed_of_light | = 1 speed_of_light
    12345678901234567890123456789012345678901234567890123456789012345678901234567890 | = 1.23457e+79

    # prefixes
    kilo | = 1000
    #k | = 1000  -- XXX we'd like this to work, at least alone!
    kibimeter | uncanceled free unit kibimeter
    Kimeter | uncanceled free unit Kimeter
    kibibyte | [Storage]
    KiByte | [Storage]

    # precedence and associativity
    2*(3+4) | = 14
    (2*3)+4 | = 10
    2+3*4 | = 14
    2*3+4 | = 10
    (4^2)^3 | = 4096
    4^(2^3) | = 65536
    4^2^3 | = 65536
    1/2?4 | = 0.125 4
    1?2/4 | = 2 2/4
    1 2/4 | = 0.5
    1/2 4 | = 0.125
    ({2})[(4)] | = 8
    (1+(2+3)*(1+2)) | = 16
    -3 | = -3
    --3 | = 3
    ---3 | = -3
    (-2)(+2) | = -4
    (-2)(-2) | = 4
    -foot-foot ? inch | = -24 inch
    (-foot)(-foot) ? sqft | = 1 sqft
    -foot^2 ? sqft | = 1 sqft
    -foot*2 ? foot | = -2 foot
    0+foot | [Length]
    0-foot | [Length]
    cal per (gm deltaK) | [Specific_heat_m or LENGTH^2*TIME^-2*TEMP^-1]
    1/3*cal per (gm deltaK) | [Specific_heat_m or LENGTH^2*TIME^-2*TEMP^-1]
    1/(3 cal per (gm deltaK)) | [Specific_heat_m^-1 or LENGTH^-2*TIME^2*TEMP]
    m per sec per sec | [Acceleration or LENGTH*TIME^-2]
    1/(m per sec per sec) | [Acceleration^-1 or LENGTH^-1*TIME^2]

    # functions
    3 3 | = 9
    square 2 | = 4
    square(3 3) | = 81
    square 3 3 | = 27
    cubic 2 | = 8
    cubic(2 2) | = 64
    cubic 2 2 | = 16
    sqrt 64 | = 8
    sqrt(4 4) | = 4
    sqrt 4 4 | = 8
    sin(pi/2) | = 1
    cos(pi/4) | = 0.707107
    tan(pi/4) | = 1
    asn(1) ? radian | = 1.5708 radian, Caution: Calculation involves units of cycle or revolution; see Calchemy Help.
    acs(1/sqrt(2)) ? degrees | = 45 degrees
    atn(1) ? grad | = 50 grad
    ln(e) | = 1
    log(10) | = 1
    exp(1) | = 2.71828
    sqrt[4] | = 2
    sqrt{4} | = 2

    # alternation
    1;1;1 | = 1
    2;3;4 | = 24, = 1.5, = 0.666667, = 0.0416667, = 2.66667, = 0.166667, = 6, = 0.375

    # smoke test
    57*84|=4788
    60mph ? fps | = 88 fps
    speed_of_light ? meter/second | = 299792000 meter/second
    speed_of_light ? mph | = 670617000 mph
    2;3 | = 6, = 0.666667, = 1.5, = 0.166667
    lb | [Mass], [Force or MASS*LENGTH*TIME^-2]
    ft | [Length]
    21 inches * 0.25 acre ? gallons | = 142560 gallons
    gal^.33333333 | [Length]
    square mm * 1000^2 ? square m | = 1 square m
    (3kg?lb)-3 | > (3 kilo~gramm ? poundm) - 3, > (3 kilo~gramf ? poundf) - 3, = 3.61387 lb
    (3kg?(lb))-3 | > (3 kilo~gramm ? poundm) - 3, > (3 kilo~gramf ? poundf) - 3, = 3.61387 (lb)

    # free units and plurals
    2 dogs * 1 cat/dog ? cats | = 2 cats
    2 ponies * 1 box/pony ? boxes | = 2 boxes
    meter ? meters | = 1 meters
    metres ? meter | = 1 meter
    miles ? inches | = 63360 inches
    anches ? anch | = 1 anch
    anch ? anches | = 1 anches
    andies ? andy | = 1 andy
    andy ? andies | = 1 andies
    3 wolves?wolf | > 3 wolves ? wolves, = 3 wolf
    3 lives? life | > 3 lives ? lives, = 3 life
    3 life ? lives | > 3 life ? life, = 3 lives
    3 wolf ? wolves | > 3 wolf ? wolf, = 3 wolves    

    # variables
    foo=
    foo=2;3
    foo | = 6, = 0.666667, = 1.5, = 0.166667
    foo=
    foo | uncanceled free unit foo
    boo=
    boo=ft lb
    boo | [MASS*LENGTH], [Energy or Torque or MASS*LENGTH^2*TIME^-2]
    boo=
    boo | uncanceled free unit boo
    boo = ft lb : Torque
    boo | [Energy or Torque or MASS*LENGTH^2*TIME^-2]
    boo=
    boo | uncanceled free unit boo
    goo=
    goo = 1
    goo | = 1
    goo =
    goo | uncanceled free unit goo
    Mass =
    Mass | [Mass]
    Mass = Length
    Mass | [Mass], [Length]
    Mass =
    Mass | [Mass]
    abc=
    abc=1
    abc += 2
    abc | = 1, = 2
    abc+=2lb
    TEST details abc | === unit details abc ===, abc=1 [], abc=2 [], abc=2lb [Mass], abc=2lb [Force or MASS*LENGTH*TIME^-2]
    abc | > abc, = 1, > abc, = 2
    abc-=2lb:Force
    abc | = 1, = 2
    abc-=1
    abc-=2
    abc | [Mass]
    abc=
    person; person; person | uncanceled free unit person

    # multi-line examples
    volume=
    volume = 8 feet * 7 feet * 8 inch : gal
    volume; (1 cal/(cc deltac)) (90 - 50) deltaf / (400 watt) ? day | = 2.84411 day
    volume=
    seed=
    seed=2cc
    1 seed/square foot; 200 acre ? bushels | = 494.451 bushels
    seed=
    flow,power=
    flow = 1 acre * 2 inches / (1 day) : cfm
    power = (flow * 1 gram/cc) * (9.81 m/s^2) * (100 feet) : hp
    power / (110 volts) ? amps | = 6.46784 amps
    1 acre; 2 inches; 1 day; d_water; grav; 100 feet; 110 volts ? amps | = 6.46563 amps
    flow,power=
    scalecm=
    scalecm=2000 ft
    3.2 scalecm * 4.8 scalecm ? acres | = 1410.47 acres
    scalecm=
    1&2&3|= 1, = 2, = 3
    area,power=
    area = (20 ft * 8 ft * 2) + (20 ft * 7 ft * 2) + (7 ft * 8 ft * 2) : Area
    power=area * (30 deltaf) / (11 rvalue) : Power
    (20 lb * 37e6 btu/ton) / power ? day | = 7.93929 day
    area,power=

    # temperatures
    25 degC ? degF | > ((25 + 273.15) deltaC ? deltaF) - 459.67, = 77 degF , Caution: Calculation involves offset temperature units; see Calchemy Help.
    77 degF ? degC | > ((77 + 459.67) deltaF ? deltaC) - 273.15, = 25 degC
    25 absC ? absF | = 77 absF
    77 absF ? absC | = 25 absC
    +-40 degC ? degF | = -40 degF
    +-40 degF ? degC | = -40 degC

    # si  -- XXX seems weird these are passed up as mismatch string with "= "...
    lb? | = 0.453592 kilogramm,= 4.44822 newton
    1? | = 1
    3 foot/(2 second) | [Speed or LENGTH*TIME^-1]
    3 foot/(2 second) ? | = 0.4572 meter/second
    3 lbf * 3 foot ? | = 12.2024 joule, = 12.2024 newton meter
    joule*meter | [MASS*LENGTH^3*TIME^-2]
    joule*meter?|= 1 kilogramm*meter^3*second^-2
    shm_water?|= 4184 joule/(kilogramm*deltaK)
    $?|= 1 dollar
    1kgm^4 | [MASS^4]
    1kgm^4? | = 1 kilogramm^4
    1m^4 | [LENGTH^4]
    1m^4? | = 1 meter^4
    1/grav? | = 0.101972 (meter/second^2)^-1
    1/2 pi sqrt(23 millihenry * 10 microfarad) ? | = 331.861 hertz
    visc_air? | > visc_air ? [Viscosity], = 0.0000178 pascal*second

    # dimensions
    Length | [Length]
    Length ? 1 | Dimensional Mismatch [Length^-1]
    cup^(1/3) | [Length]
    acre^(1/2) | [Length]
    s?1 | Dimensional Mismatch [Frequency or Angular_velocity or Time^-1]
    s | [Time or Frequency^-1 or Angular_velocity^-1]
    s? | = 1 second
    kgm | [Mass]
    kgm? | = 1 kilogramm
    1 kgm?1 | Dimensional Mismatch [Mass^-1]
    kgm? | = 1 kilogramm
    kg | [Mass], [Force or MASS*LENGTH*TIME^-2]
    kg? | = 1 kilogramm, = 9.80665 newton
    kg?1 | Dimensional Mismatch [Mass^-1], Dimensional Mismatch [Force^-1 or MASS^-1*LENGTH^-1*TIME^2]
    kg? | = 1 kilogramm, = 9.80665 newton
    pi*radian | unexpected exponents of pi and radian; use pi_as_number or pin to escape
    pi_as_number*radian | > pi_as_number * radian, = 3.14159
    400cc* 2pi 3500 rpm ? cfm | > 400 cc * 2 pi 3500 rpm_as_frequency ? cfm, = 310.644 cfm
    10.4889 ft lb ? |>10.4889foot poundm?,=1.45014kilogramm*meter,>10.4889foot poundf?[Energy],=14.221joule,>10.4889foot poundf?[Torque],=14.221newton meter

    # auto-inversion
    3 sec ? Hz | > (3 second) ^ -1 ? hertz, = 0.333333 Hz, Caution: Calculation auto-inverted left-hand-side.
    3 mL/50 meter ? mpg | > (3 milli~liter / (50 meter)) ^ -1 ? mpg, = 39.2024 mpg, Caution: Calculation auto-inverted left-hand-side.
    rpm ? minute/revolution | > (rpm_as_angular_velocity) ^ -1 ? minute / revolution_as_angle, > (rpm_as_frequency) ^ -1 ? minute / revolution_as_number, = 1 minute/revolution,`+
    `Caution: Calculation auto-inverted left-hand-side.
    rpm?|> rpm_as_angular_velocity ? [Angular_velocity], = 0.10472 radian/second, > rpm_as_frequency ? [Frequency], = 0.0166667 hertz

    # interpretations
    1 foot^2 | > 1 (foot)^2, [Area or Fuel_efficiency^-1 or LENGTH^2]
    1/2*feet * 2 meters ? | > (1 / 2) * foot * 2 meter ? [Area], = 0.3048 meter^2
    1/sqrt(23mH * 10uF)? |>1/(23milli~henry*10micro~farad)^0.5?[Frequency],=2085.14hertz,>1/(23milli~henry*10micro~farad)^0.5?[Angular_velocity],=2085.14radian/second
    20000 btu/hour; 80% * 14 megajoules/day/meter^2 ? ft^2 | > (20000 Btu / hour) / ((80 percent * 14 mega~joule / day) / (meter)^2) ? (foot)^2, = 486.71 ft^2
    2 square meter | > 2 (meter)^2, [Area or Fuel_efficiency^-1 or LENGTH^2]
    --3 | > 0-(0-3), = 3
    cal/(gm deltaK) | > calorie/(gramm deltaK), [Specific_heat_m or LENGTH^2*TIME^-2*TEMP^-1]
    1/cal/(gm deltaK) |> (1 / calorie) / (gramm deltaK), [MASS^-2*LENGTH^-2*TIME^2*TEMP^-1]
    1/(cal/(gm deltaK)) | > 1 / (calorie/(gramm deltaK)), [Specific_heat_m^-1 or LENGTH^-2*TIME^2*TEMP]
    (1+1);(1+2) | > (1 + 1) * (1 + 2), = 6, > (1 + 1) / (1 + 2), = 0.666667, > (1 + 1)^-1 * (1 + 2), = 1.5, > ((1 + 1) * (1 + 2))^-1, = 0.166667
    foo=lb | > poundm, > poundf, defined
    foo=2;3 | > 2 * 3, > 2 / 3, > (2)^-1 * 3, > (2 * 3)^-1, defined
    foo=lb : MASS | > poundm, defined
    foo=lb : Force | > poundf, defined
    foo= | undefined
    g?lb | > gramm ? poundm, > gramf ? poundf, = 0.00220462 lb
    lb;lb?1 | > poundm / poundm ? 1, > poundf / poundf ? 1, = 1 1
    asn 1 | > asn(1), = 1.5708
    q=asn 1 | > asn(1), defined
    q=

    2pi sqrt(1meter/grav);1?|>2pi(1meter/gravity)^0.5*1?[Time],>2pi(1meter/gravity)^0.5/1?[Time],=2.00641second,>(2pi(1meter/gravity)^0.5)^-1*1?`+
    `[Frequency],>((2pi(1meter/gravity)^0.5)*1)^-1?[Frequency],=0.498403hertz

    # filters, parameters
    in:ftlb | incompatible units :ftlb
    Area:1 | incompatible units :1
    1:Area | incompatible units :Area
    1:m^2 | incompatible units :(meter)^2
    Area?1 | Dimensional Mismatch [Fuel_efficiency or Area^-1 or LENGTH^-2]
    1?Area | Dimensional Mismatch [Area or Fuel_efficiency^-1 or LENGTH^2]
    abc:Area | specify value for abc
    Area:abc | incompatible units :abc

    # help examples
    3 meter ? inch | = 118.11 inch
    2000 lbf * (10 * 12 feet) / (1 minute) ? horsepower |= 7.27273 horsepower
    2000 lbf * (10 * 12 feet) ? horsepower | Dimensional Mismatch [Frequency or Angular_velocity or Time^-1]
    2+3*5 | = 17
    2000 lb; 10 stories; 12 feet/story; 1 minute ? horsepower | > 2000 poundf * 10 stories * (12 foot / stories) / (1 minute) ? horsepower, = 7.27273 horsepower
    sin(pi/2) | = 1
    atn(1) | = 0.785398
    sin(90 degrees) | = 1
    atn(1) ? degrees | = 45 degrees
    2000 lbm * grav * 60 mph ? hp | = 320 hp
    10 mph * 30 feet * 10 gal/acre ? gal/min | = 6.06061 gal/min
    43 feet * (pi * (0.25 inch)^2) / (3 gal/min) ? sec | = 8.77198 sec
    40 gal * shv_water * (140-45) deltaF / (40000 Btu/hour) ? hour | = 0.79228 hour
    40 knot / (2500 rpm * 90%) ? inch/rev |> 40 knot / (2500 rpm_as_angular_velocity * 90 percent) ? inch / revolution_as_angle,`+
    `> 40 knot / (2500 rpm_as_frequency * 90 percent) ? inch / revolution_as_number, = 21.604 inch/rev
    1/(2 pi sqrt(23mH; 10uF))?Hz | = 331.861 Hz
    20000 btu/hour; 80% * 14 megajoules/day/square meter ? ft^2 | = 486.71 ft^2
    (3/4) cup * shv_water * (212 - 52) deltaF / (2 min + 4 sec) ? watt | = 532.196 watt
    asn(2000 lb; 65 hp - 12 hp; 55 mph) ? degrees | = 10.4095 degrees
    speed = 60 mph & force = 20 lb : Force
    speed*force ? hp | = 3.2 hp
    speed = & force =

    # help precedence
    2*3^4 - 2*(3^4) | = 0
    2*3*4 - (2*3)*4 | = 0
    2^3^4 - 2^(3^4) | = 0
    1/2*3 - (1/2)*3 | = 0
    1/2 3 - 1/(2*3) | = 0
    1/(2)(3) - 1/(2*3) | = 0
    1*2/3 - (1*2)/3 | = 0
    1*2 per 3 - (1*2)/3 | = 0
    1/2 foot - 1/(2*foot) ? | = 0 (meter)^-1
    3 meter / 2 seconds - (3 meter)/(2 seconds) ? | = 0 meter/second
    3 kgm meter/s^2 - ((3 * kgm) * meter)/(s^2) ? | = 0 newton
    3 cal/gm deltaK - (3 * cal)/(gm * deltaK) ? | = 0 joule/(kilogramm*deltaK)
    3 cal per gm deltaK - (3 * cal)/(gm * deltaK) ? | = 0 joule/(kilogramm*deltaK)
    3 cal/(gm deltaK) - (3 * cal)/(gm * deltaK) ? | = 0 joule/(kilogramm*deltaK)
    3 cal per (gm deltaK) - (3 * cal)/(gm * deltaK) ? | = 0 joule/(kilogramm*deltaK)

    # unit help
    TEST details lb | === unit details lb ===,poundm,lbm,lb*,pound*=453.592 gramm [Mass], poundf,lbf,lb*,pound*=1 poundm*gravity [Force or MASS*LENGTH*TIME^-2]
    TEST details ft | === unit details ft ===,foot,ft,feet=12 inch [Length]
    TEST details kilobyte | === unit details kilobyte ===,PREFIX Prefix,SI:kilo,k=1E+03*Byte*,byte*,B,char*=8 bit #computer storage [Storage]
    TEST byname lb | === units by name lb ===,ftlb,inlb,lb,lbf,lbm
    TEST byname ft | === units by name ft ===,bdft,cuft,ft,fT,ftce,fTCE,ftesla,ftlb,ftoe,fTOE,fton_explosive,fton_metric,ftonf_metric,ftonm_metric,ftonne,`+
    `ftonnef,ftonnem,ftorr,ftTNT,sqft
    TEST byname kilobyte | === units by name kilobyte ===,kilobyte,kiloByte,kilobyte_per_second
    TEST byname U | === units by name U ===,amu,au,btu,Btu,BTU,btu_mean,btu_thermochem,bu,chu,entropy_unit,uval,Uval,uvalue,Uvalue
    TEST byname wc | === units by name wc ===,inwc,inWc,wc,Wc
    TEST bycategory Torque | === units in category Torque ===, ftlb, inlb, newton meter
    TEST bycategory Angle | === units in category Angle ===,arcmin,arcsec,cycle,cycle_as_angle,cyclea,deg,degree,grad,grade,rad,radian,rev,rev_as_angle,reva,revolution,`+
    `revolution_as_angle,revolutiona
    TEST bycategory abc | === units in category abc ===
    TEST bycategory Angular_velocity|===unitsincategoryAngular_velocity===,cpd,cpd_as_angular_velocity,cpda,cps,cps_as_angular_velocity,cpsa,radian/second,rpm,`+
    `rpm_as_angular_velocity,rpma,rps,rps_as_angular_velocity,rpsa

    # various errors
    TEST throw | unknown test throw
    TEST details abc | undefined unit abc
    TEST byname abc | undefined unit abc
    3/0 | = Infinity
    3**2 | expected a value before *
    tricycles | uncanceled free unit tricycles
    gal^.33 | non-integral exponent
    sqrt(meter) | non-integral exponent
    1^meter | non-dimensionless exponent
    foot+second | addition of dissimilar units
    foot-second | subtraction of dissimilar units
    boo = abc | undefined unit abc
    ( | unmatched parenthesis (
    sin | missing argument sin
    sin(1 meter) | non-dimensionless argument
    *2 | expected a value before *
    BASE | missing unit
    ^=0 | unexpected ^
    =0 | missing name
    () | missing expression
    [(0) | unmatched parenthesis [
    [(0]) | unmatched parenthesis [
    ([0)] | unmatched parenthesis (
    ?? | ? may only occur once
    :: | expected a value before :
    == | = may only occur once
    ww:q=1 | undefined category ww
    asn(2000 lb; 65 hp - 12 hp; 55 mph) ? degrees | = 10.4095 degrees
    1/sqrt(23 mi:li) | incompatible units :li
    1/sqrt(23 mi,li) | bad token ,
    foot+0 | addition of dissimilar units
    foot-0 | subtraction of dissimilar units
`;

// the user clicked the Test button; run the unit test
function Test()
{
    // append a temporary deletable chunk to the results list with the test in progress
    lasttag = "";
    Chunk(null, "tests started ...");
    Scroll();
    setTimeout(TestReal, 100);  // XXX -- why does 0 not work?
}

// run the unit test for real, after the display renders that tests have started
function TestReal()
{
    try {
        var lines = (tests+examples+preequations+equations+postequations+database_tests).split(/[\r\n]+/);
        testing = true;
        offset_warn = false;
        offset_warned = false;
        cycle_warn = false;
        cycle_warned = false;

        var tested = 0;
        var passed = 0;
        var start = new Date();
        var firsttag = lasttag;

        var html = "";

        // for all tests...
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].replace(/^ *[#].*/, "").trim();  // # for comment only at beginning of line
            if (line.length) {
                tested++;

                // get the test equation line and expected results on either side of the '|'
                console.log("Test " + line);
                var sides = line.split('|');
                if (sides.length >= 3) {
                    html += "<br>test failed: " + line + " -- | may only occur once";
                    continue;
                }

                // run the test
                lasttag = "";
                document.getElementById("equation").value = sides[0];
                Enter();
                var output = SnoopAndDelete(lasttag);

                for (var j = 0; j < output.length; j++) {
                    output[j] = output[j].replace(/[&]gt[;]/, ">");
                }

                // if expected results do not include interpretations...
                if (sides.length == 2 && ! sides[1].match(/[>]/)) {
                    // search for interpretations in the test output
                    for (j = output.length-1; j >= 0; j--) {
                        if (output[j].match(/[>]/)) {
                            // get the interpretation
                            var interpretation = output[j];

                            // remove the interpretation
                            output.splice(j, 1);

                            // run the re-interpretation
                            var results = RunLine(interpretation.replace(/[>]/, ""));
                            if (! results.success) {
                                html += "<br>test failed: " + line + " interpretation:" + interpretation + "error:" + results.output.toString();
                                break;
                            }

                            if (results.output.length == 2) {
                                // XXX -- handle length != 2???
                                var lhs = results.output[1].trim();
                                if (lhs.match(/^= /)) {
                                    lhs = lhs.replace(/^=  */, "").replace(/ .*/, "");
                                }
                                var rhs = output[j].trim();
                                if (rhs.match(/^= /)) {
                                    rhs = rhs.replace(/^=  */, "").replace(/ .*/, "");
                                }
                                if (lhs != rhs) {
                                    html += "<br>test failed: " + line + " interpretation:" + interpretation + "miscompare:" + results.output.toString();
                                    break;
                                }
                            }
                        }
                    }
                    if (j >= 0) {
                        continue;
                    }
                }

                // if we have expected output...
                if (sides.length == 2) {
                    // verify that the expected output matches
                    var expected = sides[1].split(',');
                    if (output.length == 0 && (expected.length == 0 || (expected.length == 1 && expected[0] == ""))) {
                        // ignore split weirdness with no input
                    } else {
                        // if the actual output did not match the expected output...
                        if (output.join().replace(/  */g, "") != expected.join().replace(/  */g, "")) {
                            // the test failed!
                            html += "<br>test failed: " + line + " -- expected: " + expected.toString() + " output: " + output.toString();
                            continue;
                        }
                    }
                    passed++;
                } else {
                    // no expected output
                    passed++;
                }
            }
        }

        var ms = new Date() - start;

        // replace the temporary deletable chunk in the results list with the actual test results
        Delete(firsttag);
        Chunk(null, "tests started ..." + html + "<br>... " + passed + " (" + Math.trunc(passed*100/tested) + "%) of " + tested + " tests passed in " + ms + " ms");
    } catch (error) {
        Chunk(null, error);
    } finally {
        offset_warn = false;
        offset_warned = false;
        cycle_warn = false;
        cycle_warned = false;
        testing = false;
    }
    Scroll();
}

var help =`
<h1 id='toc'>Calchemy&trade; -- Math Magic</h1>
<ul>
<li><a href=#overview>Overview</a>
<ul>
    <li><a href=#basic>Basic Features</a></li>
    <li><a href=#advanced>Advanced Features</a>
    <ul>
        <li><a href=#solve>Solve By Dimensional Analysis</a></li>
        <li><a href=#overload>Overloaded Units</a></li>
        <li><a href=#free>Free Units</a></li>
        <li><a href=#plural>Pluralized Units</a></li>
    </ul></li>
</ul></li>
<li><a href=#syntax>Equation Syntax</a>
<ul>
    <li><a href=#operators>Operators</a></li>
    <li><a href=#functions>Functions</a></li>
</ul></li>
<li><a href=#definition>Definition Syntax</a></li>
<li><a href=#ui>User Interface</a>
<ul>
    <li><a href=#history>History List</a></li>
    <li><a href=#line>Equation Line</a></li>
    <li><a href=#buttons>Buttons</a></li>
</ul></li>
<li><a href=#examples>Examples</a></li>
<li><a href=#database>Database Notes</a>
<ul>
    <li><a href=#custom>Custom Database</a></li>
    <li><a href=#runtime>Runtime Database</a></li>
</ul></li>
<li><a href=#cautions>Cautions</a>
<ul>
    <li><a href=#cycle>Units of Cycle or Revolution</a></li>
    <li><a href=#offset>Offset Temperature Units</a></li>
</ul></li>
<li><a href=#info>For More Information</a></li>
</ul>

<h1 id='overview'>Overview</h1>
<p>Calchemy&trade; is an exciting
<a href='https://github.com/rtestardi/calchemy/wiki/The-History-of-Calchemy%E2%84%A2%2C-1988-to-Present' target='_blank'>not-so-new</a>
units calculator which allows you to perform dimensional arithmetic, analysis, and conversions using any standard units.
Calchemy "understands" the relationships between these units and performs conversions for you automatically as needed.
It also checks your equations to ensure that they are always dimensionally correct.
<p>Calchemy now runs as javascript, entirely in your web browser.
Calchemy does not send any of your information or equations or results over the Internet.
Calchemy does not use cookies, though it does use "other site data" in your browser for persistence of the History List.
<p>N.B. The persistent history list is cleared when you clear your browser cookies and other site data.
<p>You can verify Calchemy's operation by clicking the "Test" button. 
<p>Always double-check your answers!
<p>The following examples provide a brief introduction to some of Calchemy's features.
<h2 id='basic'>Basic Features</h2>
<p>To perform a simple unit conversion, such as 3 meters converted to inches, you could enter the equation (or click/tap on the link):
<p><a href="javascript:Hyperlink('3 meter ? inch')">3 meter ? inch</a>
<p>Calchemy would respond:
<p>= 118.11 inch
<p>To calculate the required horsepower for a motor which could raise a 2000 lbf elevator to the top of a 10 story building (assuming 12 feet per story) in 1 minute,
you could enter the equation:
<p><a href="javascript:Hyperlink('2000 lbf * (10 * 12 feet) / (1 minute) ? horsepower')">2000 lbf * (10 * 12 feet) / (1 minute) ? horsepower</a>
<p>Indicating that you want to multiply 2000 pounds force by 10 times 12 feet, divide that by 1 minute, and then express the final result in horsepower.
Calchemy would respond:
<p>= 7.27273 horsepower
<p>If, on the other hand, you had made a mistake in the original equation and left out the "/ (1 minute)":
<p><a href="javascript:Hyperlink('2000 lbf * (10 * 12 feet) ? horsepower')">2000 lbf * (10 * 12 feet) ? horsepower</a>
<p>Calchemy would have responded with a Dimensional Mismatch indication containing:
<p>Time^-1
<p>Indicating that the left hand side of the equation was missing a factor of 1/Time -- the equation was not dimensionally correct, and therefore, could not be evaluated.
<p>Calchemy can also be used as a simple dimensionless calculator by eliminating the "?" and result unit from the equation. For example, you could enter the equation:
<p><a href="javascript:Hyperlink('2+3*5')">2+3*5</a>
<p>Calchemy would respond with the algebraically correct answer:
<p>= 17

<h2 id='advanced'>Advanced Features</h2>
<p>You could also enter the original equation in the following less explicit form:
<p><a href="javascript:Hyperlink('2000 lb; 10 stories; 12 feet/story; 1 minute ? horsepower')">2000 lb; 10 stories; 12 feet/story; 1 minute ? horsepower</a>
<p>Indicating that you want to "combine" 2000 pounds, 10 stories, 12 feet/story, and 1 minute in such a way that the equation is dimensionally correct,
and then express the final result in horsepower.
Calchemy would again respond:
<p><i>&gt; 2000 poundf * 10 stories * (12 foot / stories) / (1 minute) ? horsepower</i>
<br>= 7.27273 horsepower
<p>Notice above that Calchemy will always show you how it is interpreting your equations, with a line that begins with "&gt;".
<p>This example illustrates the following features:
<h3 id='solve'>Solve By Dimensional Analysis</h3>
<p>The "<b>;</b>" operator tells Calchemy to use dimensional analysis to determine whether its operands should be in the numerator or the denominator of the equation.
In this example, Calchemy placed the first three operands in the numerator and the last operand in the denominator.
This allows you to be less involved with the actual mechanics of the equations.
<h3 id='overload'>Overloaded Units</h3>
<p>The "lb" unit is an overloaded unit, meaning that it has more than one common definition.
It is primarily defined as "lbm" (pounds mass) and secondarily defined as "lbf" (pounds force).
Calchemy automatically uses the appropriate definition, again based on dimensional analysis.
In this example, Calchemy used "lbf".  This allows you to naturally use units with multiple common definitions.
<h3 id='free'>Free Units</h3>
<p>The "stories" and "story" units are called free units.
Free units are units which are not actually understood by Calchemy, except in that they are new and unique dimensions which must "cancel out" in the end.
This allows you to enter equations in a more natural format.
<h3 id='plural'>Pluralized Units</h3>
<p>The "stories" and "story" units also illustrate that Calchemy understands basic pluralization rules for units.
This, again, allows you to enter equations in a more natural format.

<h1 id='syntax'>Equation Syntax</h1>
<p>Basic Calchemy equations are of the form:
<p><b>expression ? unit</b>
<p>Where <b>expression</b> is the arithmetic expression you want evaluated, and <b>unit</b> is the unit you want the result expressed in.
<p>To evaluate an expression with a dimensionless result, use the form:
<p><b>expression</b>
<p>To evaluate an expression with a dimensionally consistent (though possibly wrong, see <a href=#cautions>Cautions</a>) SI result unit chosen by Calchemy, use the form:
<p><b>expression ?</b>

<p>You can enter a comment into your result history by preceding it with a pound sign, like:
<p><b># comment ...</b>
<p>You can enter multiple equations on the same line by separating then with an ampersand, like:
<p><b>equation1 &amp; equation2 ...</b>
<p>You can also enter equations directly from the calchemy.html URL, by using <b><i>URL encoding</i></b> after the query '?', like:
<p>.../calchemy.html?<b><i>urlequation</i></b>

<h2 id='operators'>Operators</h2>
<p>Equations may contain the following binary operators (listed in decreasing order of precedence):
<table border=1>
<tr><td>Operator...</td><td>Meaning...</td></tr>
<tr><td>~</td><td>prefix multiplication</td></tr>
<tr><td>^</td><td>exponentiation</td></tr>
<tr><td></td><td>implied multiplication</td></tr>
<tr><td>* / per</td><td>multiplication, division</td></tr>
<tr><td>+ -</td><td>addition, subtraction</td></tr>
<tr><td>:</td><td>dimensional filter</td></tr>
<tr><td>;</td><td>solve by dimensional analysis</td></tr>
</table>
<p>All operators except "^" are left-associative; "^" is right-associative.
<p>Side-by-side operands (with no intervening punctuation) are evaluated with an implied multiplication.
The precedence of implied multiplication is just above that of multiplication and division.
<p>The "per" operator performs a division, with a precedence equal to that of division.
<p>The ":" operator is a dimensional filter that limits evaluations of its left-hand-side to the dimension(s) of its right-hand-side.
<p>The ";" operator is what we call "solve by dimensional analysis" which evaluates all combinations of the left-hand-side and right-hand-side
in the numerator and denominator of the equation, discarding any dimensionally incorrect results.
<p>Calchemy evaluates higher precedence operators before lower precedence operators.
Left-associative operators of the same precedence are evaluated from left to right; right-associative operators of the same precedence are evaluated from right to left.
The following table illustrates these rules:
<table border=1>
<tr><td>This...</td><td>Is evaluated as...</td></tr>
<tr><td>2*3^4</td><td>2*(3^4)</td></tr>
<tr><td>2*3*4</td><td>(2*3)*4</td></tr>
<tr><td>2^3^4</td><td>2^(3^4)</td></tr>
<tr><td>1/2*3</td><td>(1/2)*3</td></tr>
<tr><td>1/2 3</td><td>1/(2*3)</td></tr>
<tr><td>1/(2)(3)</td><td>1/(2*3)</td></tr>
<tr><td>1*2/3</td><td>(1*2)/3</td></tr>
<tr><td>1*2 per 3</td><td>(1*2)/3</td></tr>
<tr><td>1/2 foot</td><td>1/(2*foot)</td></tr>
<tr><td>3 meter / 2 seconds</td><td>(3 meter)/(2 seconds)</td></tr>
<tr><td>3 kgm meter/s^2</td><td>((3 * kgm) * meter)/(s^2)</td></tr>
<tr><td>3 cal/gm deltaK</td><td>(3 * cal)/(gm * deltaK)</td></tr>
<tr><td>3 cal per gm deltaK</td><td>(3 * cal)/(gm * deltaK)</td></tr>
<tr><td>3 cal/(gm deltaK)</td><td>(3 * cal)/(gm * deltaK)</td></tr>
<tr><td>3 cal per (gm deltaK)</td><td>(3 * cal)/(gm * deltaK)</td></tr>
</table>
<p>"+" and "-" can also be used as highest-precedence right-associative unary operators.
<p>Parentheses (or brackets or braces) can be used to explicitly override the default precedences and associativities, and group operations.
<p>When in doubt, it is always best to parenthesize!

<h2 id='functions'>Functions</h2>
<p>Equations may also contain the following high-precedence functions:
<table border=1>
<tr><td>Function...</td><td>Meaning...</td></tr>
<tr><td>sqrt(x)</td><td>square root of x</td></tr>
<tr><td>log(x)</td><td>log base 10 of x</td></tr>
<tr><td>exp(x)</td><td>e to the x</td></tr>
<tr><td>ln(x)</td><td>natural log of x</td></tr>
<tr><td>sin(x)</td><td>sine of x (radians)</td></tr>
<tr><td>cos(x)</td><td>cosine of x (radians)</td></tr>
<tr><td>tan(x)</td><td>tangent of x (radians)</td></tr>
<tr><td>asn(x)</td><td>arc-sine (radians) of x</td></tr>
<tr><td>acs(x)</td><td>arc-cosine (radians) of x</td></tr>
<tr><td>atn(x)</td><td>arc-tangent (radians) of x</td></tr>
</table>
<p>Note that the arguments to these functions should always be parenthesized to avoid precedence confusion.
<p>The default base unit for trigonometric and inverse-trigonometric functions is the radian.
To enter arguments in or convert results to any other unit (e.g., degrees), you must explicitly specify the unit.
Explicitly specifying radians is recommended, but not required.
The following examples illustrate this:
<p><a href="javascript:Hyperlink('sin(pi/2)')">sin(pi/2)</a>
<br>= 1
<p><a href="javascript:Hyperlink('atn(1)')">atn(1)</a>
<br>= 0.785398
<p><a href="javascript:Hyperlink('sin(90 degrees)')">sin(90 degrees)</a>
<br>= 1
<p><a href="javascript:Hyperlink('atn(1) ? degrees')">atn(1) ? degrees</a>
<br>= 45 degrees
 
<p>The square root function can work on arguments with any dimensions with even exponents. 
Note also that "square root" is the same as exponentiation to the 1/2 power; similarly, "cube root" is the same as exponentiation to the 1/3 power.
The following examples illustrate this:
<p><a href="javascript:Hyperlink('sqrt(2 acres) ? meters')">sqrt(2 acres) ? meters</a>
<br>= 89.9651 meters
<p><a href="javascript:Hyperlink('(2 acres)^(1/2) ? meters')">(2 acres)^(1/2) ? meters</a>
<br>= 89.9651 meters
<p><a href="javascript:Hyperlink('(10000 gallons)^(1/3) ? feet')">(10000 gallons)^(1/3) ? feet</a>
<br>= 11.016 feet

<p>All other functions work only on dimensionless arguments and return dimensionless results.
The following examples illustrate this:
<p><a href="javascript:Hyperlink('exp(1)')">exp(1)</a>
<br>= 2.71828
<p><a href="javascript:Hyperlink('ln(2.71828)')">ln(2.71828)</a>
<br>= 0.999999
<p><a href="javascript:Hyperlink('log(100)')">log(100)</a>
<br>= 2
 
<p>Calchemy also understands the following functional modifiers to allow you to enter units in a more natural format.
<table border=1>
<tr><td>This...</td><td>Is the same as ...</td></tr>
<tr><td>square u</td><td>u^2</td></tr>
<tr><td>cubic u</td><td>u^3</td></tr>
</table>
<p>For example, the following are both equivalent:
<p><a href="javascript:Hyperlink('3 meters^2')">3 meters^2</a>
<p><a href="javascript:Hyperlink('3 square meters')">3 square meters</a>

<h1 id='definition'>Definition Syntax</h1>
<p>Basic Calchemy definitions are of the form:
<p><b>name = expression</b>
<p>Where <b>name</b> is the name of the unit you want defined and <b>expression</b> is the arithmetic expression you want the unit defined to.
<p>To undefine all definitions of a unit name, use the form:
<p><b>name =</b>
<p>To add an additional (overloaded) definition to a unit, use the form:
<p><b>name += expression</b>
<p>To remove a specific (overloaded) definition from a unit, use the form:
<p><b>name -= expression</b>
<p>Note when using unit definitions:
<ul>
<li>units may have multiple definitions,</li>
<li>fundamental units cannot be undefined, and</li>
<li>unit definitions and undefinitions are lost when Calchemy is reloaded!</li>
</ul>
<p>For example, if you enter:
<p><a href="javascript:Hyperlink('speed = 60 mph')">speed = 60 mph</a>
<p><a href="javascript:Hyperlink('force = 20 lb : Force')">force = 20 lb : Force</a>
<p><a href="javascript:Hyperlink('speed*force ? hp')">speed*force ? hp</a>
<p>Calchemy would respond:
<p>= 3.2 hp
<p>If you want to be able to refer to your newly defined unit in the plural form, define its singular as:
<p><b>name* = expression</b>

<h1 id='ui'>User Interface</h1>
<p>Less frequently used buttons are at the top of the user interface; more frequently used buttons are at the bottom of the user interface, near the Equation Line.

<h2 id='history'>History List</h2>
<p>The History List is near the top of the user interface and grows to include all your calculated equations and results;
initially, the history list contains only the words, "database loaded".
<p>Equations and results in the history list are hyperlinks which you can click/tap to re-enter the equation or result into the Equation Line, as a form of history recall.
<p>The history list also contains unit category names or unit names you have searched for (also as hyperlinks) as well as unit details, examples, equations, and online help.
<p>Each entry in the history list can be deleted by clicking/tapping its &lt;Delete&gt; button;
all entries in the history list can be deleted by clicking/tapping the &lt;Delete All&gt; button at the top of the user interface.
<p>To scroll to the bottom of the user interface, click the &lt;Bottom&gt; button at the top of the user interface;
to scroll to the top of the user interface, click the &lt;Top&gt; button at the bottom of the user interface.
<p>N.B. The persistent history list is cleared when you clear your browser cookies and other site data.

<h2 id='line'>Equation Line</h2>
<p>The Equation Line is below the history list and above the bottom buttons, and is where you enter unit equations and unit definitions;
initially, the equation line contains the words, "enter expression ? unit".
<p>When you are done entering a unit equation or unit definition, press the &lt;Enter&gt; key or click/tap the &lt;Enter&gt; button to evaluate the equation or definition,
and transfer it and its results to the History List.
<p>You can use the &lt;Up Arrow&gt; and &lt;Down Arrow&gt; keys to recall previous equations and results from the history list.

<h2 id='buttons'>Buttons</h2>
<p>The following less frequently used Buttons are at the top of the user interface:
<dl>
<dt>&lt;Test&gt;</dt><dd>Run the internal tests to confirm proper javascript operation.</dd>
<dt>&lt;Example&gt;</dt><dd>Copy an example equation into the equation line.</dd>
<dt>&lt;Copy All&gt;</dt><dd>Copy the history list and equation line to the clipboard.</dd>
<dt>&lt;Paste&gt;</dt><dd>Paste the contents of the clipboard into the equation line, evaluating one equation at a time, stopping if an error occurs.
<br>N.B. to use this feature, the calchemy html file must be accessed either thru https or locally, and you must be running Chrome or New Edge.</dd>
<dt>&lt;Load&gt;</dt><dd>Load an additional runtime text units database from the local computer or javascript units database from the location of calchemy.html.</dd>
<dt>&lt;Help&gt;</dt><dd>Display this internal online help.</dd>
<dt>&lt;Delete All&gt;</dt><dd>Delete all entries in the history list.</dd>
<dt>&lt;Bottom&gt;</dt><dd>Scroll to the bottom of the user interface.</dd>
</dl>
<p>The following Buttons are in the middle of the user interface, within the history list:
<dl>
<dt>&lt;Delete&gt;</dt><dd>Delete an entry in the history list.</dd>
</dl>
<p>The following more frequently used Buttons are at the bottom of the user interface:
<dl>
<dt>&lt;Enter&gt;</dt><dd>Evaluate the equation or definition in the equation line.</dd>
<dt>&lt;Clear&gt;</dt><dd>Clear the equation line.</dd>
<dt>&lt;Find Units&gt;</dt><dd>If a portion of a unit is at the the cursor of the equation line, display all possible unit names that match the portion;
otherwise, display all unit category names;
click/tap a unit category name to display all unit names in the category;
click/tap a unit name to enter its name into the equation line at the cursor.</dd>
<dt>&lt;Unit Details&gt;</dt><dd>Display the unit details (definition and dimension) for the unit at the cursor of the equation line.</dd>
<dt>&lt;Equations&gt;</dt><dd>Display a list of equation groups.
Click/tap an equation group to display all equations in the group.
Click/tap an equation to enter it into the equation line at the cursor.</dd>
<dt>&lt;Top&gt;</dt><dd>Scroll to the top of the user interface.</dd>
</dl>

<h1 id='examples'>Examples</h1>
<p>What is the braking power required to decelerate a 2000 lbm car at 1G at 60 mph?
<p><a href="javascript:Hyperlink('2000 lbm * grav * 60 mph ? hp')">2000 lbm * grav * 60 mph ? hp</a>
<br>= 320 hp
<p>What is the flow rate required if a farmer wants to apply 10 gal/acre of fertilizer using a tractor with a speed of 10 mph and a swath width of 30 feet?
<p><a href="javascript:Hyperlink('10 mph * 30 feet * 10 gal/acre ? gal/min')">10 mph * 30 feet * 10 gal/acre ? gal/min</a>
<br>= 6.06061 gal/min
<p>What is the delay for hot water if the flow rate is 3 gal/min and the water heater is connected to the tap with 43 feet of 1/2 inch id tube?
<p><a href="javascript:Hyperlink('43 feet * (pi * (0.25 inch)^2) / (3 gal/min) ? sec')">43 feet * (pi * (0.25 inch)^2) / (3 gal/min) ? sec</a>
<br>= 8.77198 sec
<p>How long will it take a 40,000 Btu/hr water heater to heat 40 gallons of water from 45 degrees F to 140 degrees F?
<p><a href="javascript:Hyperlink('40 gal * shv_water * (140-45) deltaF / (40000 Btu/hour) ? hour')">40 gal * shv_water * (140-45) deltaF / (40000 Btu/hour) ? hour</a>
<br>= 0.79228 hour
<p>What prop pitch is required for a boat to do 40 knots at 2500 rpm, assuming 10% slip?
<p><a href="javascript:Hyperlink('40 knot / (2500 rpm * 90%25) ? inch/rev')">40 knot / (2500 rpm * 90%) ? inch/rev</a>
<br>= 21.604 inch/rev
<p>What is the frequency of an LC oscillator?
<p><a href="javascript:Hyperlink('1/(2 pi sqrt(23mH; 10uF))?Hz')">1/(2 pi sqrt(23mH; 10uF))?Hz</a>
<br>= 331.861 Hz
<p>How large of a solar collector do you need to heat a house with 20,000 Btu/hr assuming 80% efficiency?
(Solar insolation for Denver in February is 14 megajoules/day/square meter.)
<p><a href="javascript:Hyperlink('20000 btu/hour; 80%25 * 14 megajoules/day/square meter ? ft^2')">20000 btu/hour; 80% * 14 megajoules/day/square meter ? ft^2</a>
<br>= 486.71 ft^2
<p>How many watts is a microwave oven putting out if it can bring 3/4 cup of water from 52 degrees F to a boil in 2 minutes and 4 seconds?
<p><a href="javascript:Hyperlink('(3/4) cup * shv_water * (212 - 52) deltaF / (2 min + 4 sec) ? watt')">(3/4) cup * shv_water * (212 - 52) deltaF / (2 min + 4 sec) ? watt</a>
<br>= 532.196 watt
<p>What is the maximum angle a 2000 lb car with a 65 hp engine can climb at 55 mph, assuming 12 hp of drag at that speed:
<p><a href="javascript:Hyperlink('asn(2000 lb; 65 hp - 12 hp; 55 mph) ? degrees')">asn(2000 lb; 65 hp - 12 hp; 55 mph) ? degrees</a>
<br>= 10.4095 degrees

<h1 id='database'>Database Notes</h1>
<p>Units in the Calchemy database are case sensitive, and must be used with their proper case in equations.
The &lt;Find Units&gt; button allows you to also find units that differ by case, since some units have proper definitions whose case may be surprising (like Hz and Btu).
<p>Prefixable units in the database may be prefixed with a standard SI prefix (like mega or micro) or its abbreviation (like M or u);
storage units (like bit or Byte) may also be prefixed with a standard SI binary prefix (like mebi or gibi) or its abbreviation (like Mi or Gi).
<p>The Calchemy database contains a number of physical properties grouped by a short prefix, as follows:
<table border=1>
<tr><td>d_...</td><td>density of ...</td></tr>
<tr><td>e_...</td><td>energy of ...</td></tr>
<tr><td>hcm_...</td><td>heat of combustion by mass of ...</td></tr>
<tr><td>hcv_...</td><td>heat of combustion by volume of ...</td></tr>
<tr><td>hc_...</td><td>heat of combustion by mass or volume of ...</td></tr>
<tr><td>hfm_...</td><td>heat of fusion by mass of ...</td></tr>
<tr><td>hfv_...</td><td>heat of fusion by volume of ...</td></tr>
<tr><td>hf_...</td><td>heat of fusion by mass or volume of ...</td></tr>
<tr><td>hvm_...</td><td>heat of vaporization by mass of ...</td></tr>
<tr><td>hvv_...</td><td>heat of vaporization by volume of ...</td></tr>
<tr><td>hv_...</td><td>heat of vaporization by mass or volume of ...</td></tr>
<tr><td>mm_...</td><td>molecular mass of ...</td></tr>
<tr><td>m_...</td><td>atomic mass of ...</td></tr>
<tr><td>n_...</td><td>atomic number of ...</td></tr>
<tr><td>shm_...</td><td>specific heat by mass of ...</td></tr>
<tr><td>shv_...</td><td>specific heat by volume of ...</td></tr>
<tr><td>sh_...</td><td>specific heat by mass or volume of ...</td></tr>
<tr><td>ss_...</td><td>speed of sound in ...</td></tr>
<tr><td>tc_...</td><td>thermal conductivity of ...</td></tr>
<tr><td>visc_...</td><td>viscosity of ...</td></tr>
<tr><td>v_...</td><td>voltage of ...</td></tr>
</table>
<p>The Calchemy database also contains a number of derived units appended with a short suffix, as follows:
<table border=1>
<tr><td>..._m</td><td>... by mass</td></tr>
<tr><td>..._v</td><td>... by volume</td></tr>
</table>
<h2 id='custom'>Custom Database</h2>
<p>A custom javascript database named custom.js will automatically be loaded from the location of calchemy.html.
To take advantage of this feature you will typically copy calchemy.html to a local folder, create custom.js in the same folder, and launch calchemy.html from that folder.
Custom.js must define the javascript variable "custom" as a multi-line template string containing one or more unit definitions and/or undefinitions within back-ticks, like:
<pre>
custom=&#096;
foreverandaday=1e99 years+1 day
slowasmolasses=0.001 mph
&#096;;
</pre>
<h2 id='runtime'>Runtime Database</h2>
<p>A database from a text file on the local computer may be loaded at runtime by clicking/tapping the &lt;Load&gt; button, selecting "Local Database", and browsing to the file.
The file should contain text lines with one or more unit definitions and/or undefinitions, like:
<pre>
foreverandaday=1e99 years+1 day
slowasmolasses=0.001 mph
</pre>
<p>
<p>An optional javascript database from the location of calchemy.html may also be loaded at runtime by clicking/tapping the &lt;Load&gt; button and
selecting the javascript database in the list.
<p>Runtime unit definitions and undefinitions are lost when Calchemy is reloaded!

<h1 id='cautions'>Cautions</h1>
<p>Calchemy makes problem solving so easy that it is tempting to assume that any answer it gives you is correct.
However, as with all calculators, the answer it gives you is only as good as the data you give it.
<p>Calchemy ensures that the data you give it is dimensionally consistent.
<p>However, there are more aspects to good data than simple dimensional consistency.
Many physical equations also include dimensionless factors like 2 pi, an efficiency, or 1/2, or involve offset temperature units.
Beware that Calchemy cannot tell if you have left out (or inadvertently included) one of these factors.
<p>You must know the physical equation for the problem you are trying to solve before entering it into Calchemy!
And you must enter any dimensionless factors into Calchemy along with the other parameters of the physical equation, as these factors are part of the physical equation!
Note that true physical equations do not specify the units used for the parameters.
If your equation demands that parameters be entered in specific units, it is not a physical equation and cannot be used with Calchemy.
(These equations usually contain some unusual conversion factor that represents the combined conversions required to make the specific units of the equation coherent.)
<p>Always double-check your answers!

<h2 id='cycle'>Units of Cycle or Revolution</h2>
<p>In Calchemy, as in SI, the unit for radian (angle) is defined as dimensionless 1; the unit for hertz (frequency) is defined as 1/second.
This can lead to unexpected results, such as a radians/second being numerically equal to a hertz.
This is unfortunate and there is no perfect answer here;
neither angles and numbers nor angular velocities and frequencies can be distinguished by Calchemy, since the have the same dimensions.
Calchemy cannot tell if you have left out or accidentally included a factor of 2 pi in your physical equation.
<p>In Calchemy, the units of revolution and cycle are defined as overloaded units as <i>both</i> numbers and angles,
and as such the units for rpm, cps, etc., are also defined as overloaded units as both frequencies and angular velocities.
Calchemy will always show you which definition it is using when interpreting your equations, and you may receive multiple results from ambiguous equations.
<p>The fundamental units of Calchemy are defined as follows:

<table border=1>
<tr><td>radian, rad</td><td>1</td></tr>
<tr><td>hertz, Hz</td><td>1/second</td></tr>
</table>

<h3>Angle or Number</h3>
<p>Use ..._as_angle or ...a units in equations for "theta" or angle; use ..._as_number or ...n units in equations for "n" or number.
<table border=1>
<tr><td>suffix:</td><td>..._as<wbr>_angle<br>...a</td><td>..._as<wbr>_number<br>...n</td></tr>
<tr><td>cycle</td><td>2 pi</td><td>1</td></tr>
<tr><td>revolution, rev</td><td>2 pi</td><td>1</td></tr>
</table>

<h3>Angular_velocity or Frequency</h3>
<p>Use ..._as_angular_velocity or ...a units in equations for "omega" or angular velocity; use ..._as_frequency or ...f units in equations for "f" or frequency.
<table border=1>
<tr><td>suffix:</td><td>..._as<wbr>_angular_velocity<br>...a</td><td>..._as<wbr>_frequency<br>...f</td></tr>
<tr><td>cpd</td><td>2 pi/day</td><td>1/day</td></tr>
<tr><td>cps</td><td>2 pi/second</td><td>1/second</td></tr>
<tr><td>rpm</td><td>2 pi/minute</td><td>1/minute</td></tr>
<tr><td>rps</td><td>2 pi/second</td><td>1/second</td></tr>
</table>

<p>N.B. Calchemy considers equations with both powers of "pi" and powers of "radian" to be dimensionally incorrect;
to escape this restriction, replace "pi" in your equation with "pi_as_number" or "pin".

<h2 id='offset'>Offset Temperature Units</h2>
<p>In Calchemy, the degC (and absC) and degF (and absF) units are defined as offsets into the Celsius and Fahrenheit temperature scales.
As such, every time you enter one of these, you can and should think of it as being instantly converted to absolute Kelvin and Rankine temperatures.
Likewise, when you ask for a result in degC or degF, the evaluated (absolute) Kelvin or Rankine temperature result is then converted back to Celsius or Fahrenheit.
Calchemy cannot tell if you have accidentally converted a offset temperature into an absolute temperature or not.
<p>Conversely, the deltaC (and deltaK) and deltaF (and deltaR) units are defined as the "interval" of 1 degree in the Celsius (and Kelvin) and Fahrenheit (and Rankine)
temperature scales, much like the "interval" of a pound or a watt, where 2 times one interval equals 2 intervals...

<h2>Overloaded Units</h2>
In the case of units which traditionally have more than one common use (such as "ounce", which can be a unit of mass, force, or volume),
Calchemy understands all of the uses and the unit is said to be an overloaded unit.
Calchemy will use any of the definitions for a unit that result in a dimensionally correct equation.
Calchemy will always show you which definition for a unit it is using when interpreting your equations, and you may receive multiple results from ambiguous equations.
<p>The following units (in addition to Units of Cycle or Revolution listed above) are defined as overloaded units:
<table border=1>
<tr><td>gram</td><td>mass or force</td></tr>
<tr><td>ounce, oz</td><td>mass or force or volume</td></tr>
<tr><td>pound, lb</td><td>mass or force</td></tr>
<tr><td>ton</td><td>mass or force</td></tr>
<tr><td>ton_metric, tonne</td><td>mass or force</td></tr>
<tr><td>ton_long</td><td>mass or force</td></tr>
</table>
<p>To force Calchemy to use a specific definition for a unit, you can use a ...m, ...f, or ...v suffix.

<h2>Ambiguous Dimensions</h2>
<p>Dimensions such as Torque and Energy are identical, only differing in an unspecified vector component.
Similarly, dimensions such as Pressure and Latent Heat by Volume are surprisingly identical, only differing in their use!

<h2>Numeric Precision</h2>
<p>Calchemy is not intended to be used for high precision calculations.
<p>The number of significant digits typically carried by Calchemy during the phases of its calculations are summarized in the following table:
<table border=1>
<tr><td>Phase...</td><td>Digits...</td></tr>
<tr><td>numeric input</td><td>10</td></tr>
<tr><td>calculations</td><td>10</td></tr>
<tr><td>database units</td><td>6</td></tr>
<tr><td>database physical constants</td><td>6</td></tr>
<tr><td>database physical properties</td><td>&lt;4 *</td></tr>
<tr><td>numeric results</td><td>6</td></tr>
</table>
<p>* Note that database physical properties are also limited by the fact that they are typically an average over a range of assumptions.
<p>Again, always double-check your answers!

<h1 id='info'>For More Information</h1>
<p>Visit us on the web at: <a href=http://www.calchemy.com target=_blank>http://www.calchemy.com</a>
<p>See the GitHub Repository at: <a href=https://github.com/rtestardi/calchemy target=_blank>https://github.com<wbr>/rtestardi/calchemy</a>
`;

// the user clicked the Help button; show the internal help and point to calchemy.com
function Help()
{
    // append a deletable chunk to the results list with the help, replacing any existing chunk so TOC hyperlinks work
    Chunk("=== help ===", help);
    document.getElementById('toc').scrollIntoView();
    Scroll(true);
}

</script>

</body>

</html>
